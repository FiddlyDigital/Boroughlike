var t,e;!function(t){!function(e){var r="object"==typeof global?global:"object"==typeof self?self:"object"==typeof this?this:Function("return this;")(),s=i(t);function i(t,e){return function(r,s){"function"!=typeof t[r]&&Object.defineProperty(t,r,{configurable:!0,writable:!0,value:s}),e&&e(r,s)}}void 0===r.Reflect?r.Reflect=t:s=i(r.Reflect,s),function(t){var e=Object.prototype.hasOwnProperty,r="function"==typeof Symbol,s=r&&void 0!==Symbol.toPrimitive?Symbol.toPrimitive:"@@toPrimitive",i=r&&void 0!==Symbol.iterator?Symbol.iterator:"@@iterator",n="function"==typeof Object.create,o={__proto__:[]}instanceof Array,a=!n&&!o,h={create:n?function(){return st(Object.create(null))}:o?function(){return st({__proto__:null})}:function(){return st({})},has:a?function(t,r){return e.call(t,r)}:function(t,e){return e in t},get:a?function(t,r){return e.call(t,r)?t[r]:void 0}:function(t,e){return t[e]}},c=Object.getPrototypeOf(Function),l="object"==typeof process&&process.env&&"true"===process.env.REFLECT_METADATA_USE_MAP_POLYFILL,u=l||"function"!=typeof Map||"function"!=typeof Map.prototype.entries?tt():Map,p=l||"function"!=typeof Set||"function"!=typeof Set.prototype.entries?et():Set,f=new(l||"function"!=typeof WeakMap?rt():WeakMap);function d(t,e,r,s){if(j(r)){if(!z(t))throw new TypeError;if(!U(e))throw new TypeError;return R(t,e)}if(!z(t))throw new TypeError;if(!B(e))throw new TypeError;if(!B(s)&&!j(s)&&!N(s))throw new TypeError;return N(s)&&(s=void 0),T(t,e,r=X(r),s)}function y(t,e){function r(r,s){if(!B(r))throw new TypeError;if(!j(s)&&!K(s))throw new TypeError;P(t,e,r,s)}return r}function g(t,e,r,s){if(!B(r))throw new TypeError;return j(s)||(s=X(s)),P(t,e,r,s)}function m(t,e,r){if(!B(e))throw new TypeError;return j(r)||(r=X(r)),k(t,e,r)}function v(t,e,r){if(!B(e))throw new TypeError;return j(r)||(r=X(r)),M(t,e,r)}function w(t,e,r){if(!B(e))throw new TypeError;return j(r)||(r=X(r)),A(t,e,r)}function b(t,e,r){if(!B(e))throw new TypeError;return j(r)||(r=X(r)),E(t,e,r)}function S(t,e){if(!B(t))throw new TypeError;return j(e)||(e=X(e)),C(t,e)}function _(t,e){if(!B(t))throw new TypeError;return j(e)||(e=X(e)),O(t,e)}function x(t,e,r){if(!B(e))throw new TypeError;j(r)||(r=X(r));var s=L(e,r,!1);if(j(s))return!1;if(!s.delete(t))return!1;if(s.size>0)return!0;var i=f.get(e);return i.delete(r),i.size>0||f.delete(e),!0}function R(t,e){for(var r=t.length-1;r>=0;--r){var s=(0,t[r])(e);if(!j(s)&&!N(s)){if(!U(s))throw new TypeError;e=s}}return e}function T(t,e,r,s){for(var i=t.length-1;i>=0;--i){var n=(0,t[i])(e,r,s);if(!j(n)&&!N(n)){if(!B(n))throw new TypeError;s=n}}return s}function L(t,e,r){var s=f.get(t);if(j(s)){if(!r)return;s=new u,f.set(t,s)}var i=s.get(e);if(j(i)){if(!r)return;i=new u,s.set(e,i)}return i}function k(t,e,r){if(M(t,e,r))return!0;var s=$(e);return!N(s)&&k(t,s,r)}function M(t,e,r){var s=L(e,r,!1);return!j(s)&&H(s.has(t))}function A(t,e,r){if(M(t,e,r))return E(t,e,r);var s=$(e);return N(s)?void 0:A(t,s,r)}function E(t,e,r){var s=L(e,r,!1);if(!j(s))return s.get(t)}function P(t,e,r,s){L(r,s,!0).set(t,e)}function C(t,e){var r=O(t,e),s=$(t);if(null===s)return r;var i=C(s,e);if(i.length<=0)return r;if(r.length<=0)return i;for(var n=new p,o=[],a=0,h=r;a<h.length;a++){var c=h[a];n.has(c)||(n.add(c),o.push(c))}for(var l=0,u=i;l<u.length;l++){c=u[l];n.has(c)||(n.add(c),o.push(c))}return o}function O(t,e){var r=[],s=L(t,e,!1);if(j(s))return r;for(var i=q(s.keys()),n=0;;){var o=Z(i);if(!o)return r.length=n,r;var a=J(o);try{r[n]=a}catch(t){try{Q(i)}finally{throw t}}n++}}function I(t){if(null===t)return 1;switch(typeof t){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return null===t?1:6;default:return 6}}function j(t){return void 0===t}function N(t){return null===t}function F(t){return"symbol"==typeof t}function B(t){return"object"==typeof t?null!==t:"function"==typeof t}function D(t,e){switch(I(t)){case 0:case 1:case 2:case 3:case 4:case 5:return t}var r=3===e?"string":5===e?"number":"default",i=V(t,s);if(void 0!==i){var n=i.call(t,r);if(B(n))throw new TypeError;return n}return W(t,"default"===r?"number":r)}function W(t,e){if("string"===e){var r=t.toString;if(G(r))if(!B(i=r.call(t)))return i;if(G(s=t.valueOf))if(!B(i=s.call(t)))return i}else{var s;if(G(s=t.valueOf))if(!B(i=s.call(t)))return i;var i,n=t.toString;if(G(n))if(!B(i=n.call(t)))return i}throw new TypeError}function H(t){return!!t}function Y(t){return""+t}function X(t){var e=D(t,3);return F(e)?e:Y(e)}function z(t){return Array.isArray?Array.isArray(t):t instanceof Object?t instanceof Array:"[object Array]"===Object.prototype.toString.call(t)}function G(t){return"function"==typeof t}function U(t){return"function"==typeof t}function K(t){switch(I(t)){case 3:case 4:return!0;default:return!1}}function V(t,e){var r=t[e];if(null!=r){if(!G(r))throw new TypeError;return r}}function q(t){var e=V(t,i);if(!G(e))throw new TypeError;var r=e.call(t);if(!B(r))throw new TypeError;return r}function J(t){return t.value}function Z(t){var e=t.next();return!e.done&&e}function Q(t){var e=t.return;e&&e.call(t)}function $(t){var e=Object.getPrototypeOf(t);if("function"!=typeof t||t===c)return e;if(e!==c)return e;var r=t.prototype,s=r&&Object.getPrototypeOf(r);if(null==s||s===Object.prototype)return e;var i=s.constructor;return"function"!=typeof i||i===t?e:i}function tt(){var t={},e=[],r=function(){function t(t,e,r){this._index=0,this._keys=t,this._values=e,this._selector=r}return t.prototype["@@iterator"]=function(){return this},t.prototype[i]=function(){return this},t.prototype.next=function(){var t=this._index;if(t>=0&&t<this._keys.length){var r=this._selector(this._keys[t],this._values[t]);return t+1>=this._keys.length?(this._index=-1,this._keys=e,this._values=e):this._index++,{value:r,done:!1}}return{value:void 0,done:!0}},t.prototype.throw=function(t){throw this._index>=0&&(this._index=-1,this._keys=e,this._values=e),t},t.prototype.return=function(t){return this._index>=0&&(this._index=-1,this._keys=e,this._values=e),{value:t,done:!0}},t}();return function(){function e(){this._keys=[],this._values=[],this._cacheKey=t,this._cacheIndex=-2}return Object.defineProperty(e.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),e.prototype.has=function(t){return this._find(t,!1)>=0},e.prototype.get=function(t){var e=this._find(t,!1);return e>=0?this._values[e]:void 0},e.prototype.set=function(t,e){var r=this._find(t,!0);return this._values[r]=e,this},e.prototype.delete=function(e){var r=this._find(e,!1);if(r>=0){for(var s=this._keys.length,i=r+1;i<s;i++)this._keys[i-1]=this._keys[i],this._values[i-1]=this._values[i];return this._keys.length--,this._values.length--,e===this._cacheKey&&(this._cacheKey=t,this._cacheIndex=-2),!0}return!1},e.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=t,this._cacheIndex=-2},e.prototype.keys=function(){return new r(this._keys,this._values,s)},e.prototype.values=function(){return new r(this._keys,this._values,n)},e.prototype.entries=function(){return new r(this._keys,this._values,o)},e.prototype["@@iterator"]=function(){return this.entries()},e.prototype[i]=function(){return this.entries()},e.prototype._find=function(t,e){return this._cacheKey!==t&&(this._cacheIndex=this._keys.indexOf(this._cacheKey=t)),this._cacheIndex<0&&e&&(this._cacheIndex=this._keys.length,this._keys.push(t),this._values.push(void 0)),this._cacheIndex},e}();function s(t,e){return t}function n(t,e){return e}function o(t,e){return[t,e]}}function et(){return function(){function t(){this._map=new u}return Object.defineProperty(t.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),t.prototype.has=function(t){return this._map.has(t)},t.prototype.add=function(t){return this._map.set(t,t),this},t.prototype.delete=function(t){return this._map.delete(t)},t.prototype.clear=function(){this._map.clear()},t.prototype.keys=function(){return this._map.keys()},t.prototype.values=function(){return this._map.values()},t.prototype.entries=function(){return this._map.entries()},t.prototype["@@iterator"]=function(){return this.keys()},t.prototype[i]=function(){return this.keys()},t}()}function rt(){var t=16,r=h.create(),s=i();return function(){function t(){this._key=i()}return t.prototype.has=function(t){var e=n(t,!1);return void 0!==e&&h.has(e,this._key)},t.prototype.get=function(t){var e=n(t,!1);return void 0!==e?h.get(e,this._key):void 0},t.prototype.set=function(t,e){return n(t,!0)[this._key]=e,this},t.prototype.delete=function(t){var e=n(t,!1);return void 0!==e&&delete e[this._key]},t.prototype.clear=function(){this._key=i()},t}();function i(){var t;do{t="@@WeakMap@@"+c()}while(h.has(r,t));return r[t]=!0,t}function n(t,r){if(!e.call(t,s)){if(!r)return;Object.defineProperty(t,s,{value:h.create()})}return t[s]}function o(t,e){for(var r=0;r<e;++r)t[r]=255*Math.random()|0;return t}function a(t){return"function"==typeof Uint8Array?"undefined"!=typeof crypto?crypto.getRandomValues(new Uint8Array(t)):"undefined"!=typeof msCrypto?msCrypto.getRandomValues(new Uint8Array(t)):o(new Uint8Array(t),t):o(new Array(t),t)}function c(){var e=a(t);e[6]=79&e[6]|64,e[8]=191&e[8]|128;for(var r="",s=0;s<t;++s){var i=e[s];4!==s&&6!==s&&8!==s||(r+="-"),i<16&&(r+="0"),r+=i.toString(16).toLowerCase()}return r}}function st(t){return t.__=void 0,delete t.__,t}t("decorate",d),t("metadata",y),t("defineMetadata",g),t("hasMetadata",m),t("hasOwnMetadata",v),t("getMetadata",w),t("getOwnMetadata",b),t("getMetadataKeys",S),t("getOwnMetadataKeys",_),t("deleteMetadata",x)}(s)}()}(t||(t={})),function(t){t[t.Transient=0]="Transient",t[t.Singleton=1]="Singleton",t[t.ResolutionScoped=2]="ResolutionScoped",t[t.ContainerScoped=3]="ContainerScoped"}(e||(e={}));var r=e,s=function(t,e){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])},s(t,e)};function i(t,e){function r(){this.constructor=t}s(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}function n(t,e,r,s){return new(r||(r=Promise))((function(i,n){function o(t){try{h(s.next(t))}catch(t){n(t)}}function a(t){try{h(s.throw(t))}catch(t){n(t)}}function h(t){var e;t.done?i(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(o,a)}h((s=s.apply(t,e||[])).next())}))}function o(t,e){var r,s,i,n,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return n={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function a(n){return function(a){return function(n){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,s&&(i=2&n[0]?s.return:n[0]?s.throw||((i=s.return)&&i.call(s),0):s.next)&&!(i=i.call(s,n[1])).done)return i;switch(s=0,i&&(n=[2&n[0],i.value]),n[0]){case 0:case 1:i=n;break;case 4:return o.label++,{value:n[1],done:!1};case 5:o.label++,s=n[1],n=[0];continue;case 7:n=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==n[0]&&2!==n[0])){o=0;continue}if(3===n[0]&&(!i||n[1]>i[0]&&n[1]<i[3])){o.label=n[1];break}if(6===n[0]&&o.label<i[1]){o.label=i[1],i=n;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(n);break}i[2]&&o.ops.pop(),o.trys.pop();continue}n=e.call(t,o)}catch(t){n=[6,t],s=0}finally{r=i=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,a])}}}function a(t){var e="function"==typeof Symbol&&Symbol.iterator,r=e&&t[e],s=0;if(r)return r.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&s>=t.length&&(t=void 0),{value:t&&t[s++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function h(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var s,i,n=r.call(t),o=[];try{for(;(void 0===e||e-- >0)&&!(s=n.next()).done;)o.push(s.value)}catch(t){i={error:t}}finally{try{s&&!s.done&&(r=n.return)&&r.call(n)}finally{if(i)throw i.error}}return o}function c(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(h(arguments[e]));return t}var l="injectionTokens";function u(t){return!!t.useClass}function p(t){return!!t.useFactory}var f=function(){function t(t){this.wrap=t,this.reflectMethods=["get","getPrototypeOf","setPrototypeOf","getOwnPropertyDescriptor","defineProperty","has","set","deleteProperty","apply","construct","ownKeys"]}return t.prototype.createProxy=function(t){var e,r=this,s=!1;return new Proxy({},this.createHandler((function(){return s||(e=t(r.wrap()),s=!0),e})))},t.prototype.createHandler=function(t){var e={};return this.reflectMethods.forEach((function(r){e[r]=function(){for(var e=[],s=0;s<arguments.length;s++)e[s]=arguments[s];return e[0]=t(),Reflect[r].apply(void 0,c(e))}})),e},t}();function d(t){return"string"==typeof t||"symbol"==typeof t}function y(t){return"object"==typeof t&&"token"in t&&"transform"in t}function g(t){return!!t.useToken}function m(t){return null!=t.useValue}var v=function(){function t(){this._registryMap=new Map}return t.prototype.entries=function(){return this._registryMap.entries()},t.prototype.getAll=function(t){return this.ensure(t),this._registryMap.get(t)},t.prototype.get=function(t){this.ensure(t);var e=this._registryMap.get(t);return e[e.length-1]||null},t.prototype.set=function(t,e){this.ensure(t),this._registryMap.get(t).push(e)},t.prototype.setAll=function(t,e){this._registryMap.set(t,e)},t.prototype.has=function(t){return this.ensure(t),this._registryMap.get(t).length>0},t.prototype.clear=function(){this._registryMap.clear()},t.prototype.ensure=function(t){this._registryMap.has(t)||this._registryMap.set(t,[])},t}(),w=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e}(v),b=function(){this.scopedResolutions=new Map};function S(t,e,r){var s,i,n=h(t.toString().match(/constructor\(([\w, ]+)\)/)||[],2)[1],o=function(t,e){return null===t?"at position #"+e:'"'+t.split(",")[e].trim()+'" at position #'+e}(void 0===n?null:n,e);return s="Cannot inject the dependency "+o+' of "'+t.name+'" constructor. Reason:',void 0===i&&(i="    "),c([s],r.message.split("\n").map((function(t){return i+t}))).join("\n")}var _=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e}(v),x=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e}(v),R=function(){this.preResolution=new _,this.postResolution=new x},T=new Map,L=function(){function t(t){this.parent=t,this._registry=new w,this.interceptors=new R,this.disposed=!1,this.disposables=new Set}return t.prototype.register=function(t,e,s){var i;if(void 0===s&&(s={lifecycle:r.Transient}),this.ensureNotDisposed(),i=function(t){return u(t)||m(t)||g(t)||p(t)}(e)?e:{useClass:e},g(i))for(var n=[t],o=i;null!=o;){var a=o.useToken;if(n.includes(a))throw new Error("Token registration cycle detected! "+c(n,[a]).join(" -> "));n.push(a);var h=this._registry.get(a);o=h&&g(h.provider)?h.provider:null}if((s.lifecycle===r.Singleton||s.lifecycle==r.ContainerScoped||s.lifecycle==r.ResolutionScoped)&&(m(i)||p(i)))throw new Error('Cannot use lifecycle "'+r[s.lifecycle]+'" with ValueProviders or FactoryProviders');return this._registry.set(t,{provider:i,options:s}),this},t.prototype.registerType=function(t,e){return this.ensureNotDisposed(),d(e)?this.register(t,{useToken:e}):this.register(t,{useClass:e})},t.prototype.registerInstance=function(t,e){return this.ensureNotDisposed(),this.register(t,{useValue:e})},t.prototype.registerSingleton=function(t,e){if(this.ensureNotDisposed(),d(t)){if(d(e))return this.register(t,{useToken:e},{lifecycle:r.Singleton});if(e)return this.register(t,{useClass:e},{lifecycle:r.Singleton});throw new Error('Cannot register a type name as a singleton without a "to" token')}var s=t;return e&&!d(e)&&(s=e),this.register(t,{useClass:s},{lifecycle:r.Singleton})},t.prototype.resolve=function(t,e){void 0===e&&(e=new b),this.ensureNotDisposed();var r=this.getRegistration(t);if(!r&&d(t))throw new Error('Attempted to resolve unregistered dependency token: "'+t.toString()+'"');if(this.executePreResolutionInterceptor(t,"Single"),r){var s=this.resolveRegistration(r,e);return this.executePostResolutionInterceptor(t,s,"Single"),s}if(function(t){return"function"==typeof t||t instanceof f}(t)){s=this.construct(t,e);return this.executePostResolutionInterceptor(t,s,"Single"),s}throw new Error("Attempted to construct an undefined constructor. Could mean a circular dependency problem. Try using `delay` function.")},t.prototype.executePreResolutionInterceptor=function(t,e){var r,s;if(this.interceptors.preResolution.has(t)){var i=[];try{for(var n=a(this.interceptors.preResolution.getAll(t)),o=n.next();!o.done;o=n.next()){var h=o.value;"Once"!=h.options.frequency&&i.push(h),h.callback(t,e)}}catch(t){r={error:t}}finally{try{o&&!o.done&&(s=n.return)&&s.call(n)}finally{if(r)throw r.error}}this.interceptors.preResolution.setAll(t,i)}},t.prototype.executePostResolutionInterceptor=function(t,e,r){var s,i;if(this.interceptors.postResolution.has(t)){var n=[];try{for(var o=a(this.interceptors.postResolution.getAll(t)),h=o.next();!h.done;h=o.next()){var c=h.value;"Once"!=c.options.frequency&&n.push(c),c.callback(t,e,r)}}catch(t){s={error:t}}finally{try{h&&!h.done&&(i=o.return)&&i.call(o)}finally{if(s)throw s.error}}this.interceptors.postResolution.setAll(t,n)}},t.prototype.resolveRegistration=function(t,e){if(this.ensureNotDisposed(),t.options.lifecycle===r.ResolutionScoped&&e.scopedResolutions.has(t))return e.scopedResolutions.get(t);var s,i=t.options.lifecycle===r.Singleton,n=t.options.lifecycle===r.ContainerScoped,o=i||n;return s=m(t.provider)?t.provider.useValue:g(t.provider)?o?t.instance||(t.instance=this.resolve(t.provider.useToken,e)):this.resolve(t.provider.useToken,e):u(t.provider)?o?t.instance||(t.instance=this.construct(t.provider.useClass,e)):this.construct(t.provider.useClass,e):p(t.provider)?t.provider.useFactory(this):this.construct(t.provider,e),t.options.lifecycle===r.ResolutionScoped&&e.scopedResolutions.set(t,s),s},t.prototype.resolveAll=function(t,e){var r=this;void 0===e&&(e=new b),this.ensureNotDisposed();var s=this.getAllRegistrations(t);if(!s&&d(t))throw new Error('Attempted to resolve unregistered dependency token: "'+t.toString()+'"');if(this.executePreResolutionInterceptor(t,"All"),s){var i=s.map((function(t){return r.resolveRegistration(t,e)}));return this.executePostResolutionInterceptor(t,i,"All"),i}var n=[this.construct(t,e)];return this.executePostResolutionInterceptor(t,n,"All"),n},t.prototype.isRegistered=function(t,e){return void 0===e&&(e=!1),this.ensureNotDisposed(),this._registry.has(t)||e&&(this.parent||!1)&&this.parent.isRegistered(t,!0)},t.prototype.reset=function(){this.ensureNotDisposed(),this._registry.clear(),this.interceptors.preResolution.clear(),this.interceptors.postResolution.clear()},t.prototype.clearInstances=function(){var t,e;this.ensureNotDisposed();try{for(var r=a(this._registry.entries()),s=r.next();!s.done;s=r.next()){var i=h(s.value,2),n=i[0],o=i[1];this._registry.setAll(n,o.filter((function(t){return!m(t.provider)})).map((function(t){return t.instance=void 0,t})))}}catch(e){t={error:e}}finally{try{s&&!s.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}},t.prototype.createChildContainer=function(){var e,s;this.ensureNotDisposed();var i=new t(this);try{for(var n=a(this._registry.entries()),o=n.next();!o.done;o=n.next()){var c=h(o.value,2),l=c[0],u=c[1];u.some((function(t){return t.options.lifecycle===r.ContainerScoped}))&&i._registry.setAll(l,u.map((function(t){return t.options.lifecycle===r.ContainerScoped?{provider:t.provider,options:t.options}:t})))}}catch(t){e={error:t}}finally{try{o&&!o.done&&(s=n.return)&&s.call(n)}finally{if(e)throw e.error}}return i},t.prototype.beforeResolution=function(t,e,r){void 0===r&&(r={frequency:"Always"}),this.interceptors.preResolution.set(t,{callback:e,options:r})},t.prototype.afterResolution=function(t,e,r){void 0===r&&(r={frequency:"Always"}),this.interceptors.postResolution.set(t,{callback:e,options:r})},t.prototype.dispose=function(){return n(this,void 0,void 0,(function(){var t;return o(this,(function(e){switch(e.label){case 0:return this.disposed=!0,t=[],this.disposables.forEach((function(e){var r=e.dispose();r&&t.push(r)})),[4,Promise.all(t)];case 1:return e.sent(),[2]}}))}))},t.prototype.getRegistration=function(t){return this.isRegistered(t)?this._registry.get(t):this.parent?this.parent.getRegistration(t):null},t.prototype.getAllRegistrations=function(t){return this.isRegistered(t)?this._registry.getAll(t):this.parent?this.parent.getAllRegistrations(t):null},t.prototype.construct=function(t,e){var r=this;if(t instanceof f)return t.createProxy((function(t){return r.resolve(t,e)}));var s,i=function(){var s=T.get(t);if(!s||0===s.length){if(0===t.length)return new t;throw new Error('TypeInfo not known for "'+t.name+'"')}var i=s.map(r.resolveParams(e,t));return new(t.bind.apply(t,c([void 0],i)))}();return"function"!=typeof(s=i).dispose||s.dispose.length>0||this.disposables.add(i),i},t.prototype.resolveParams=function(t,e){var r=this;return function(s,i){var n,o,a,h;try{return"object"==typeof(h=s)&&"token"in h&&"multiple"in h?y(s)?s.multiple?(n=r.resolve(s.transform)).transform.apply(n,c([r.resolveAll(s.token)],s.transformArgs)):(o=r.resolve(s.transform)).transform.apply(o,c([r.resolve(s.token,t)],s.transformArgs)):s.multiple?r.resolveAll(s.token):r.resolve(s.token,t):y(s)?(a=r.resolve(s.transform,t)).transform.apply(a,c([r.resolve(s.token,t)],s.transformArgs)):r.resolve(s,t)}catch(t){throw new Error(S(e,i,t))}}},t.prototype.ensureNotDisposed=function(){if(this.disposed)throw new Error("This container has been disposed, you cannot interact with a disposed container")},t}(),k=new L;function M(t){return e=t,function(t,s,i){var n=Reflect.getOwnMetadata(l,t)||{};n[i]=r?{token:e,transform:r.transformToken,transformArgs:r.args||[]}:e,Reflect.defineMetadata(l,n,t)};var e,r}function A(){return function(t){T.set(t,function(t){var e=Reflect.getMetadata("design:paramtypes",t)||[],r=Reflect.getOwnMetadata(l,t)||{};return Object.keys(r).forEach((function(t){e[+t]=r[t]})),e}(t))}}function E(){return function(t){A()(t),k.registerSingleton(t)}}if("undefined"==typeof Reflect||!Reflect.getMetadata)throw new Error("tsyringe requires a reflect polyfill. Please add 'import \"reflect-metadata\"' to the top of your entry point.");const P="AssetsLoaded",C="KeyPress",O="PlayerLose",I="PlayerWin",j="GameOver",N="GameWin",F="Loading",B="Running",D="Title",W={BOOK:"book.wav",MONSTERHIT:"hit2.wav",NEWLEVEL:"newLevel.wav",PLAYERHIT:"hit1.wav",SPELL:"spell.wav"},H="effect",Y="item",X="Monster",z="tile",G="Library",U="N",K="E",V="S",q="W",J="NEXTLEVEL",Z="PLAYSOUND",Q="SETSHAKE";class ${constructor(){this.subscriptions=[]}static getInstance(){return $.instance||($.instance=new $),$.instance}subscribe(t,e){this.subscriptions[t]||(this.subscriptions[t]=[]),this.subscriptions[t].push(e)}publish(t,e){this.subscriptions[t]&&this.subscriptions[t].forEach((t=>{t&&t(e)}))}}const tt=16,et=48,rt=1e3/60,st="assets/images/";var it=function(t,e,r,s){var i,n=arguments.length,o=n<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,r):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,r,s);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(o=(n<3?i(o):n>3?i(e,r,o):i(e,r))||o);return n>3&&o&&Object.defineProperty(e,r,o),o},nt=function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)};let ot=class{constructor(){this.sounds={},this.initSounds(),$.getInstance().subscribe(Z,this.playSound.bind(this))}initSounds(){for(const t of Object.values(W))this.sounds[t]=new Audio(`assets/sounds/${t}`)}playSound(t){t&&this.sounds[t]&&(this.sounds[t].currentTime=0,this.sounds[t].play())}};ot=it([E(),nt("design:paramtypes",[])],ot);class at{constructor(t,e){this.stateMatrix=t,this.currentState={name:""},this.previousState=null,this.enterState(e)}triggerEvent(t){const e=this.currentState.getNewState(t);e&&this.enterState(e)}enterState(t){t!==this.currentState.name&&(this.currentState.onExit&&this.currentState.onExit(),this.previousState=this.currentState,this.currentState=this.stateMatrix[t],this.currentState.onEnter&&this.currentState.onEnter())}}class ht{constructor(t,e,r,s){this.name=t||"",this.transformations=e||{},this.onEnter=r,this.onExit=s}getNewState(t){return t=t||"",this.transformations[t]?this.transformations[t]:null}}const ct={Heal:[0,0],Flame:[1,0],Bolt_Horizontal:[2,0],Bolt_Vertical:[3,0]},lt=[0,0],ut={Player:[0,0],Player_Dead:[1,0],Bird:[2,0],Snake:[3,0],Tank:[4,0],Eater:[5,0],Jester:[6,0],HP:[7,0],MonsterLoad:[8,0],Turret_N:[9,0],Turret_E:[10,0],Turret_S:[11,0],Turret_W:[12,0]},pt={StairDown:[1,0],StairUp:[1,1],SpikePit:[2,0],FountainActive:[3,0],FountainInactive:[3,1],Wall:[0,2],Wall_L:[1,2],Wall_R:[2,2],Wall_LR:[3,2],Wall_T:[0,3],Wall_B:[1,3],Wall_TB:[2,3],Wall_LT:[3,3],Wall_RT:[0,4],Wall_LRT:[1,4],Wall_LB:[2,4],Wall_RB:[3,4],Wall_LRB:[0,5],Wall_LTB:[1,5],Wall_RTB:[2,5],Wall_LRTB:[3,5],Floor:[0,6],Floor_L:[1,6],Floor_R:[2,6],Floor_LR:[3,6],Floor_T:[0,7],Floor_B:[1,7],Floor_TB:[2,7],Floor_LT:[3,7],Floor_RT:[0,8],Floor_LRT:[1,8],Floor_LB:[2,8],Floor_RB:[3,8],Floor_LRB:[0,9],Floor_LTB:[1,9],Floor_RTB:[2,9],Floor_LRTB:[3,9]};class ft{constructor(t,e){this.caster=t,this.name=e}cast(){$.getInstance().publish(Z,W.SPELL)}boltTravel(t,e,r,s){let i=t.tile;for(;;){const t=i.getNeighbor(e[0],e[1]);if(!t||!t.passable)break;i=t,i.monster&&i.monster.hit(s),i.setEffect(r)}}}class dt{constructor(t,e,r,s,i){this.explored=!1,this.book=!1,this.effectIndex=null,this.effectCounter=0,this.stepEffectActive=!1,this.monster=null,this.map=t,this.x=e,this.y=r,this.sprite=s,this.passable=i}dist(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}getNeighbor(t,e){return this.map.getTile(this.x+t,this.y+e)}getAdjacentNeighbors(){return[this.getNeighbor(0,-1),this.getNeighbor(0,1),this.getNeighbor(-1,0),this.getNeighbor(1,0)]}getNeighborChain(t){let e=[0,0];switch(t){case U:e=[0,-1];break;case V:e=[0,1];break;case K:e=[1,0];break;case q:e=[-1,0];break;default:throw"Direction didn't have a valid value."}const r=[];let s=this.map.getTile(this.x,this.y);for(;null!=s;)s=s.getNeighbor(e[0],e[1]),s&&!s.passable?r.push(s):s=null;return r}getAdjacentPassableNeighbors(){return this.getAdjacentNeighbors().filter((t=>t&&t.passable))}setEffect(t){this.effectIndex=t,this.effectCounter=30}}class yt extends dt{constructor(t,e,r){super(t,e,r,pt.Floor,!0)}stepOn(t){this.book&&t&&t.isPlayer&&(this.book=!1)}}class gt extends ft{constructor(t){super(t,"PROTECT")}cast(){super.cast(),this.caster.shield=2;const t=this.caster.tile.map.getMonsters();for(let e=0;e<t.length;e++)t[e].stunned=!0}}const mt=[class extends ft{constructor(t){super(t,"WOOP")}cast(){super.cast();const t=this.caster.tile.map.randomPassableTile();t&&this.caster.move(t)}},class extends ft{constructor(t){super(t,"Quake")}cast(){super.cast();for(let t=0;t<tt;t++)for(let e=0;e<tt;e++){const r=this.caster.tile.map.getTile(t,e);if(r&&r.monster&&r.monster!=this.caster){const t=4-r.getAdjacentPassableNeighbors().length;r.monster.hit(2*t)}}$.getInstance().publish(Q,20)}},class extends ft{constructor(t){super(t,"Tornado")}cast(){super.cast();const t=this.caster.tile.map.getMonsters();for(let e=0;e<t.length;e++){const r=t[e];if(r){const t=this.caster.tile.map.randomPassableTile();t&&(r.move(t),r.teleportCounter=2)}}}},class extends ft{constructor(t){super(t,"AURA")}cast(){super.cast(),this.caster.tile.getAdjacentNeighbors().forEach((function(t){t&&(t.setEffect(ct.Heal),t.monster&&t.monster.heal(1))})),this.caster.tile.setEffect(ct.Heal),this.caster.heal(3)}},class extends ft{constructor(t){super(t,"DASH")}cast(){super.cast();let t=this.caster.tile;for(;;){const e=t.getNeighbor(this.caster.lastMove[0],this.caster.lastMove[1]);if(!e||!e.passable||e.monster)break;t=e}this.caster.tile!=t&&(this.caster.move(t),t.getAdjacentNeighbors().forEach((t=>{t&&t.monster&&(t.setEffect(ct.Flame),t.monster.stunned=!0,t.monster.hit(1))})))}},class extends ft{constructor(t){super(t,"FLATTEN")}cast(){super.cast();for(let t=1;t<15;t++)for(let e=1;e<15;e++){const r=this.caster.tile.map.getTile(t,e);r&&!r.passable&&r.map.replaceTile(t,e,new yt(r.map,t,e))}this.caster.tile.setEffect(ct.Flame),this.caster.heal(2)}},class extends ft{constructor(t){super(t,"ALCHEMY")}cast(){super.cast(),this.caster.tile.getAdjacentNeighbors().forEach((function(t){t&&!t.passable&&t.map.replaceTile(t.x,t.y,new yt(t.map,t.x,t.y))}))}},class extends ft{constructor(t){super(t,"POWERATTACK")}cast(){super.cast(),this.caster.bonusAttack=5}},gt,gt,class extends ft{constructor(t){super(t,"BOLT")}cast(){super.cast(),super.boltTravel(this.caster,this.caster.lastMove,[15+Math.abs(this.caster.lastMove[1])],4)}},class extends ft{constructor(t){super(t,"CROSS"),this.directions=[[0,-1],[0,1],[-1,0],[1,0]]}cast(){super.cast();for(let t=0;t<this.directions.length;t++){const e=0==Math.abs(this.directions[t][1])?ct.Bolt_Horizontal:ct.Bolt_Vertical;super.boltTravel(this.caster,this.directions[t],e,2)}}},class extends ft{constructor(t){super(t,"EX"),this.directions=[[-1,-1],[-1,1],[1,-1],[1,1]]}cast(){super.cast();for(let t=0;t<this.directions.length;t++)super.boltTravel(this.caster,this.directions[t],ct.Flame,3)}}];function vt(t,e){return Math.floor(Math.random()*(e-t+1))+t}function wt(t){let e,r;for(let s=1;s<t.length;s++)r=vt(0,s),e=t[s],t[s]=t[r],t[r]=e;return t}class bt{constructor(t,e,r){this.isPlayer=!1,this.stunned=!1,this.attackedThisTurn=!1,this.shield=0,this.dead=!1,this.tile=t,this.isPlayer=!1,this.stunned=!1,this.attackedThisTurn=!1,this.shield=0,this.dead=!1,this.move(t),this.sprite=e,this.hp=r,this.teleportCounter=2,this.offsetX=0,this.offsetY=0,this.lastMove=[-1,0],this.bonusAttack=0,this.hitSFX=W.MONSTERHIT}heal(t){this.hp=Math.min(6,this.hp+t),$.getInstance().publish(Z,W.PLAYERHEAL)}update(){this.teleportCounter--,this.stunned||this.teleportCounter>0?this.stunned=!1:this.act()}act(){const t=this.tile.getAdjacentPassableNeighbors().filter((t=>t&&(!t.monster||t.monster.isPlayer)));t.length&&(t.sort(((t,e)=>t.dist(this.tile)-e.dist(this.tile))),this.tryMove(t[0].x-this.tile.x,t[0].y-this.tile.y))}getDisplayX(){return this.tile.x+this.offsetX}getDisplayY(){return this.tile.y+this.offsetY}tryMove(t,e){const r=this.tile.getNeighbor(t,e);return!(!r||!r.passable)&&(this.lastMove=[t,e],r.monster?this.isPlayer!=r.monster.isPlayer&&(this.attackedThisTurn=!0,r.monster.stunned=!0,r.monster.hit(1+this.bonusAttack),this.bonusAttack=0,$.getInstance().publish(Q,5),this.offsetX=(r.x-this.tile.x)/2,this.offsetY=(r.y-this.tile.y)/2):this.move(r),!0)}hit(t){$.getInstance().publish(Z,this.hitSFX),this.shield>0||(this.hp-=t,this.hp<=0&&(this.die(),this.tile instanceof yt&&(this.tile.book=!0)))}die(){this.dead=!0,this.tile.monster=null,this.isPlayer&&(this.sprite=ut.Player_Dead)}move(t){this.tile&&(this.tile.monster=null,this.offsetX=this.tile.x-t.x,this.offsetY=this.tile.y-t.y,this.tile=t,t.monster=this,t.stepOn(this))}}class St extends bt{constructor(t){super(t,ut.Player,3),this.score=0,this.isPlayer=!0,this.teleportCounter=0,this.spells=wt(mt)[0],this.hitSFX=W.PLAYERHIT}update(){this.shield--}addSpell(){const t=wt(mt)[0];if(t){const e=new t(this);this.spells.push(e)}}castSpell(t){const e=this.spells[t];e&&(this.spells.splice(t,1),e.cast())}incrementScore(){this.score++}}class _t{constructor(t,e,r,s){this.score=0,this.run=1,this.totalScore=0,this.active=!1,this.score=null!=t?t:0,this.run=null!=e?e:1,this.totalScore=null!=r?r:0,this.active=null!=s&&s}}var xt=function(t,e,r,s){var i,n=arguments.length,o=n<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,r):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,r,s);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(o=(n<3?i(o):n>3?i(e,r,o):i(e,r))||o);return n>3&&o&&Object.defineProperty(e,r,o),o},Rt=function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},Tt=function(t,e){return function(r,s){e(r,s,t)}};let Lt=class{constructor(t,e,r){this.audioPlayer=t,this.mapper=e,this.renderer=r,this.localStorage={},this.props={level:1,numSpells:1,player:null,score:0,spawnCounter:0,spawnRate:15};const s={Loading:new ht(F,{AssetsLoaded:D},this.loadAssets.bind(this),null),Title:new ht(D,{KeyPress:B},this.showTitle.bind(this),null),Running:new ht(B,{PlayerLose:j,PlayerWin:N},this.startGame.bind(this),null),GameOver:new ht(j,{KeyPress:D},this.showGameLose.bind(this),null),GameWin:new ht(N,{KeyPress:D},this.showGameWin.bind(this),null)};this.FSM=new at(s,F),this.lastAnimateUpdate=(new Date).getTime()}init(){this.addEventHandlers(),requestAnimationFrame(this.draw.bind(this))}loadAssets(){this.renderer.initSpriteSheet((()=>{this.FSM.triggerEvent(P)}))}addEventHandlers(){const t=this,e=document.querySelector("html");e&&(e.onkeydown=t.handleInteraction.bind(this)),window.addEventListener("touchstart",t.handleInteraction.bind(this)),window.addEventListener("mousedown",t.handleInteraction.bind(this)),$.getInstance().subscribe(J,t.nextLevel.bind(this))}handleInteraction(t){switch(this.FSM.currentState.name){case F:break;case B:t&&this.handleKeypress(t);break;default:this.FSM.triggerEvent(C)}}handleKeypress(t){if(!(t=t||window.event).defaultPrevented){switch(t.key){case"Up":case"ArrowUp":case"w":case"W":this.props.player.tryMove(0,-1);break;case"Down":case"ArrowDown":case"s":case"S":this.props.player.tryMove(0,1);break;case"Left":case"ArrowLeft":case"a":case"A":this.props.player.tryMove(-1,0);break;case"Right":case"ArrowRight":case"d":case"D":this.props.player.tryMove(1,0);break;case" ":this.props.player.tryMove(0,0);break;case 1:case"1":case 2:case"2":case 3:case"3":case 4:case"4":case 5:case"5":case 6:case"6":case 7:case"7":case 8:case"8":case 9:case"9":this.props.player.castSpell(parseInt(t.key)-1),this.props.sidebarNeedsUpdate=!0}this.tick()}}draw(){if(this.FSM.currentState.name==B){const t=(new Date).getTime();t>=this.lastAnimateUpdate+rt&&(this.lastAnimateUpdate=t,this.renderer.updateScreen(this.mapper.getCurrentLevel()),this.props.sidebarNeedsUpdate&&(this.props.sidebarNeedsUpdate=!1,this.renderer.updateSidebar(this.props.level,this.props.score,this.props.player.spells))),requestAnimationFrame(this.draw.bind(this))}}tick(){const t=this.mapper.getCurrentLevel().getMonsters();for(let e=t.length-1;e>=0;e--)t[e].dead?t.splice(e,1):t[e].update();this.props.player.update(),this.props.player.dead&&(this.addScore(this.props.score,!1),this.props.sidebarNeedsUpdate=!0,this.FSM.triggerEvent(O)),this.props.spawnCounter--,this.props.spawnCounter<=0&&(this.mapper.getCurrentLevel().spawnMonster(),this.props.spawnCounter=this.props.spawnRate,this.props.spawnRate--)}showTitle(){this.renderer.showTitle(this.getScores())}showGameWin(){this.addScore(this.props.score,!0),this.renderer.showGameWin(this.props.scores)}showGameLose(){this.addScore(this.props.score,!0),this.renderer.showGameLose(this.props.scores)}startGame(){this.renderer.hideOverlays(),this.props.level=1,this.props.score=0,this.props.numSpells=1,this.mapper.reset(),this.startLevel(3,[]),this.props.sidebarNeedsUpdate=!0,this.tick(),this.draw()}startLevel(t,e){this.props.spawnRate=15,this.props.spawnCounter=this.props.spawnRate,this.mapper.getOrCreateLevel(this.props.level);const r=this.mapper.getCurrentLevel().randomPassableTile();r&&r instanceof yt&&(this.props.player=new St(r)),this.props.player.hp=t,e&&(this.props.player.spells=e),this.props.sidebarNeedsUpdate=!0}addScore(t,e){const r=this.getScores(),s=new _t(t,1,t,e),i=r.pop();i&&(i.active?(s.run=i.run+1,s.totalScore+=i.totalScore):r.push(i)),r.push(s),this.localStorage.scores=JSON.stringify(r)}getScores(){return this.localStorage.scores?JSON.parse(this.localStorage.scores):[]}nextLevel(){10==this.props.level?this.FSM.triggerEvent(I):(this.audioPlayer.playSound(W.NEWLEVEL),this.props.level++,this.startLevel(Math.min(6,this.props.player.hp+1),null),this.props.sidebarNeedsUpdate=!0)}};Lt=xt([E(),Tt(0,M("IAudioPlayer")),Tt(1,M("IMapper")),Tt(2,M("IRenderer")),Rt("design:paramtypes",[Object,Object,Object])],Lt);class kt extends dt{constructor(t,e,r){super(t,e,r,pt.FountainActive,!0),this.stepEffectActive=!0}stepOn(t){this.stepEffectActive&&t&&t.isPlayer&&(this.stepEffectActive=!1,this.sprite=pt.FountainInactive,t.heal(10))}}class Mt extends dt{constructor(t,e,r){super(t,e,r,pt.SpikePit,!0)}stepOn(t){t&&(t.hit(1),t.isPlayer&&$.getInstance().publish(Q,5))}}class At extends dt{constructor(t,e,r){super(t,e,r,pt.Wall,!1)}stepOn(){}}class Et{constructor(t,e,r,s){this.x=0,this.y=0,this.width=0,this.height=0,this.maxX=0,this.maxY=0,this.centerX=0,this.centerY=0,this.x=t||0,this.y=e||0,this.width=r||0,this.height=s||0,this.maxX=this.x+this.width,this.maxY=this.y+this.height,this.centerX=this.width>0?Math.ceil(this.x+this.width/2):0,this.centerY=this.height>0?Math.ceil(this.y+this.height/2):0}isZero(){return 0===this.x&&0===this.y&&0===this.width&&0===this.height}}class Pt{constructor(t,e,r,s){this.x=t,this.y=e,this.leafWidth=r,this.leafHeight=s,this.childLeafLeft=null,this.childLeafRight=null,this.room=new Et(0,0,0,0),this.room1=new Et(0,0,0,0),this.room2=new Et(0,0,0,0)}createRooms(t,e,r,s){if(null!==this.childLeafLeft||null!==this.childLeafRight)this.childLeafLeft&&this.childLeafLeft.createRooms(t,e,r,s),this.childLeafRight&&this.childLeafRight.createRooms(t,e,r,s),this.childLeafLeft&&this.childLeafRight&&t.createHall(this.childLeafLeft.getRoom(),this.childLeafRight.getRoom());else{const e=this.getRandomIntBetweenMinAndMax(s,Math.min(r,this.leafWidth-1)),i=this.getRandomIntBetweenMinAndMax(s,Math.min(r,this.leafHeight-1)),n=this.getRandomIntBetweenMinAndMax(this.x,this.x+(this.leafWidth-1)-e),o=this.getRandomIntBetweenMinAndMax(this.y,this.y+(this.leafHeight-1)-i);this.room=new Et(n,o,e,i),t.placeRoom(this.room)}}getRandomIntBetweenMinAndMax(t,e){return Math.floor(Math.random()*(e-t+1)+t)}splitLeaf(t){if(null!==this.childLeafLeft||null!==this.childLeafRight)return!1;let e=Math.random()>=.5;const r=this.leafWidth/this.leafHeight,s=this.leafHeight/this.leafWidth;r>=1.25?e=!1:s>=1.25&&(e=!0);const i=e?this.leafHeight-t:this.leafWidth-t;if(i<=t)return!1;const n=this.getRandomIntBetweenMinAndMax(t,i);return e?(this.childLeafLeft=new Pt(this.x,this.y,this.leafWidth,n),this.childLeafRight=new Pt(this.x,this.y+n,this.leafWidth,this.leafHeight-n)):(this.childLeafLeft=new Pt(this.x,this.y,n,this.leafHeight),this.childLeafRight=new Pt(this.x+n,this.y,this.leafWidth-n,this.leafHeight)),!0}getRoom(){if(!this.room.isZero())return this.room;if(this.childLeafLeft&&(this.room1=this.childLeafLeft.getRoom()),this.childLeafRight&&(this.room2=this.childLeafRight.getRoom()),this.childLeafLeft||this.childLeafRight){if(this.room2.isZero())return this.room1;if(this.room1.isZero())return this.room2;return Math.random()>=.5?this.room1:this.room2}return new Et(0,0,0,0)}}class Ct extends bt{constructor(t){super(t,ut.Bird,3)}}class Ot extends bt{constructor(t){super(t,ut.Snake,1)}act(){this.attackedThisTurn=!1,super.act(),this.attackedThisTurn||super.act()}}class It extends bt{constructor(t){super(t,ut.Tank,2)}update(){const t=this.stunned;super.update(),t||(this.stunned=!0)}}class jt extends bt{constructor(t){super(t,ut.Eater,1)}act(){const t=this.tile.getAdjacentNeighbors().filter((t=>t&&!t.passable));if(t.length){const e=wt(t)[0];e&&(e.map.replaceTile(e.x,e.y,new yt(e.map,e.x,e.y)),this.heal(.5))}else super.act()}}class Nt extends bt{constructor(t){super(t,ut.Jester,2)}act(){const t=this.tile.getAdjacentPassableNeighbors();if(t.length){const e=wt(t)[0];this.tryMove(e.x-this.tile.x,e.y-this.tile.y)}}}class Ft extends bt{constructor(t){super(t,ut.Turret,1),this.directions=[U,K,V,q],this.currentDirection=vt(0,3)}act(){this.currentDirection+=1,4==this.currentDirection&&(this.currentDirection=0);const t=this.directions[this.currentDirection];this.sprite=ut["Turret_"+t];const e=this.tile.getNeighborChain(t);e.some((t=>t.monster&&t.monster.isPlayer))&&e.forEach((e=>{switch(e.monster&&e.monster.hit(1),t){case U:case V:e.setEffect(ct.Bolt_Vertical);break;case K:case q:e.setEffect(ct.Bolt_Horizontal);break;default:throw"CardinalDirection didn't have a valid value."}}))}}class Bt{constructor(t,e){this.height=0,this.width=0,this.branch=G,this.width=t,this.height=e,this.monsters=new Array,this.tiles=new Array}getMonsters(){return this.monsters}getTile(t,e){return this.inBounds(t,e)?this.tiles[t][e]:null}nextLevel(){$.getInstance().publish(J,null)}randomPassableTile(){const t=this;let e=null;return function(t,e){for(let t=1e3;t>0;t--)if(e())return;throw"Timeout while trying to "+t}("get random passable tile",(function(){const r=vt(0,t.width-1),s=vt(0,t.height-1);return e=t.getTile(r,s),e&&e.passable&&!e.monster})),e}replaceTile(t,e,r){if(!this.inBounds(t,e))throw"attempting to replace a tile at non-existant location";this.tiles[t][e]=r}spawnMonster(){const t=new(0,wt([Ct,Ot,It,jt,Nt,Ft])[0])(this.randomPassableTile());this.monsters.push(t)}inBounds(t,e){return t>=0&&e>=0&&t<this.width&&e<this.height}}class Dt extends dt{constructor(t,e,r){super(t,e,r,pt.StairDown,!0)}stepOn(t){t&&t.isPlayer&&this.map.nextLevel()}}class Wt{constructor(t){this.levelNum=t,this.map=new Bt(tt,tt)}generate(){this.generateTiles(),this.populateMap()}generateTiles(){for(let t=0;t<this.map.width;t++){this.map.tiles[t]=[];for(let e=0;e<this.map.height;e++)if(0==t||0==e||t==this.map.width-1||e==this.map.height-1)this.map.tiles[t][e]=new At(this.map,t,e);else{const r=Math.random();this.map.tiles[t][e]=r<.005?new kt(this.map,t,e):r<.02?new Mt(this.map,t,e):r<.3?new At(this.map,t,e):new yt(this.map,t,e)}}}populateMap(){this.generateMonsters(),this.placeBooks(),this.placeStaircase(),this.overrideWallSpritesOnEdges()}generateMonsters(){const t=Math.ceil(this.levelNum/2)+1;for(let e=0;e<t;e++)this.map.monsters.push(this.spawnMonster())}spawnMonster(){return new(0,wt([Ct,Ot,It,jt,Nt,Ft])[0])(this.map.randomPassableTile())}placeBooks(){let t=0;for(;t<3;){const e=this.map.randomPassableTile();e&&e instanceof yt&&(t++,e.book=!0)}}placeStaircase(){const t=this.map.randomPassableTile();t&&t.map.replaceTile(t.x,t.y,new Dt(t.map,t.x,t.y))}overrideWallSpritesOnEdges(){for(let t=0;t<this.map.height;t++)for(let e=0;e<this.map.width;e++){const r=this.map.getTile(e,t);if(r instanceof At){const t=r.getAdjacentNeighbors();if(t&&t.length>0){const e=this.getSpriteVariationSuffixForTile(t,At);e&&(r.sprite=pt["Wall_"+e])}}}}getSpriteVariationSuffixForTile(t,e){let r="";return t[2]&&t[2]instanceof e&&(r+="L"),t[3]&&t[3]instanceof e&&(r+="R"),t[0]&&t[0]instanceof e&&(r+="T"),t[1]&&t[1]instanceof e&&(r+="B"),r}}class Ht extends Wt{constructor(t){super(t),this.maxLeafSize=12,this.minLeafSize=3,this.roomMaxSize=10,this.roomMinSize=3,this.leaves=[],this.generate()}generate(){this.generateTiles(),super.populateMap()}generateTiles(){this.initialiseMap();const t=new Pt(0,0,this.map.width,this.map.height);this.leaves.push(t);let e=!0;for(;e;){e=!1;for(let t=0;t<this.leaves.length;t++){const r=this.leaves[t];r&&(r.childLeafLeft||r.childLeafRight||!(r.leafWidth>this.maxLeafSize||r.leafHeight>this.maxLeafSize)||r.splitLeaf(this.minLeafSize)&&(r.childLeafLeft&&this.leaves.push(r.childLeafLeft),r.childLeafRight&&this.leaves.push(r.childLeafRight),e=!0))}}t.createRooms(this,this.maxLeafSize,this.roomMaxSize,this.roomMinSize)}initialiseMap(){for(let t=0;t<this.map.width;t++){this.map.tiles[t]=[];for(let e=0;e<this.map.height;e++)this.map.tiles[t][e]=new At(this.map,t,e)}}placeRoom(t){for(let e=t.x+1;e<t.maxX;e++)for(let r=t.y+1;r<t.maxY;r++){const t=Math.random();this.map.tiles[e][r]=t<.005?new kt(this.map,e,r):t<.02?new Mt(this.map,e,r):new yt(this.map,e,r)}}createHall(t,e){Math.random()>=.5?(this.makeHorizontalTunnel(t.centerX,e.centerX,t.centerY),this.makeVerticalTunnel(t.centerY,e.centerY,e.centerX)):(this.makeVerticalTunnel(t.centerY,e.centerY,t.centerX),this.makeHorizontalTunnel(t.centerX,e.centerX,e.centerY))}makeHorizontalTunnel(t,e,r){const s=Math.min(t,e),i=Math.max(t,e);for(let t=s;t<=i;t++)this.map.tiles[t][r]=new yt(this.map,t,r)}makeVerticalTunnel(t,e,r){for(let s=Math.min(t,e);s<=Math.max(t,e);s++)this.map.tiles[r][s]=new yt(this.map,r,s)}}class Yt{generateLevel(t,e){if(e===G)return this.generateLibraryLevel(t);throw"branch not supported"}generateLibraryLevel(t){return new Ht(t).map}}var Xt=function(t,e,r,s){var i,n=arguments.length,o=n<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,r):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,r,s);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(o=(n<3?i(o):n>3?i(e,r,o):i(e,r))||o);return n>3&&o&&Object.defineProperty(e,r,o),o},zt=function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},Gt=function(t,e){return function(r,s){e(r,s,t)}};let Ut=class{constructor(t){this.levelGenerator=t,this.currentFloorIdx=0,this.floors=new Array}getOrCreateLevel(t){let e=this.floors[t];return e?(this.currentFloorIdx=t,e):(e=this.levelGenerator.generateLevel(this.currentFloorIdx,G),this.currentFloorIdx=t,this.floors[t]=e,e)}getCurrentLevel(){return this.floors[this.currentFloorIdx]}reset(){this.floors=new Array}};Ut=Xt([E(),Gt(0,M("ILevelGenerator")),zt("design:paramtypes",[Object])],Ut);class Kt{constructor(){this.amount=0,this.x=0,this.y=0}}var Vt=function(t,e,r,s){var i,n=arguments.length,o=n<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,r):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,r,s);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(o=(n<3?i(o):n>3?i(e,r,o):i(e,r))||o);return n>3&&o&&Object.defineProperty(e,r,o),o},qt=function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)};let Jt=class{constructor(){this.showAlternateSprites=!1,this.lastAlternateSpriteTimeMS=Date.now(),this.monsterSpriteSheet=new Image,this.tileSpriteSheet=new Image,this.effectSpriteSheet=new Image,this.itemSpriteSheet=new Image,this.onLoadCompletedCallback=null;const t=document.getElementById("playerLocation");if(!t)throw"can't load pleyer location elem";this.playerLocationElem=t;const e=document.getElementById("playerBooks");if(!e)throw"can't load Player Books elem";this.playerBooksElem=e,this.shake=new Kt;const r=document.querySelector("canvas");if(!r)throw"Canvas can't load";{this.canvas=r;const t=this.canvas.getContext("2d");if(!t)throw"Ctx can't load";this.ctx=t}this.setupCanvas(),$.getInstance().subscribe(Q,this.setShakeAmount.bind(this))}initSpriteSheet(t){this.onLoadCompletedCallback=t,this.monsterSpriteSheet.onload=this.checkAllSpriteSheetsLoaded.bind(this),this.tileSpriteSheet.onload=this.checkAllSpriteSheetsLoaded.bind(this),this.effectSpriteSheet.onload=this.checkAllSpriteSheetsLoaded.bind(this),this.itemSpriteSheet.onload=this.checkAllSpriteSheetsLoaded.bind(this),this.monsterSpriteSheet.src=st+"monsters1.png",this.tileSpriteSheet.src=st+"library_new.png",this.effectSpriteSheet.src=st+"effects.png",this.itemSpriteSheet.src=st+"items.png"}checkAllSpriteSheetsLoaded(){this.monsterSpriteSheet.complete&&this.tileSpriteSheet.complete&&this.effectSpriteSheet.complete&&this.itemSpriteSheet.complete&&null!==this.onLoadCompletedCallback&&this.onLoadCompletedCallback()}setupCanvas(){this.canvas&&this.ctx&&(this.canvas.width=768,this.canvas.height=768,this.canvas.style.width=this.canvas.width+"px",this.canvas.style.height=this.canvas.height+"px",this.ctx.imageSmoothingEnabled=!1,this.ctx.font="consolas, monospace")}getSpriteSheet(t){switch(t){case X:return this.monsterSpriteSheet;case z:return this.tileSpriteSheet;case H:return this.effectSpriteSheet;case Y:return this.itemSpriteSheet;default:throw"Sprite sheet does not exist!"}}updateScreen(t){this.clearCanvas(),this.screenshake();const e=Date.now();e-this.lastAlternateSpriteTimeMS>600&&(this.showAlternateSprites=!this.showAlternateSprites,this.lastAlternateSpriteTimeMS=e);const r=[];for(let e=0;e<tt;e++)for(let s=0;s<tt;s++){const i=t.getTile(e,s);i&&(this.drawTile(i),i.monster&&r.push(i.monster))}for(let t=0;t<r.length;t++)this.drawMonster(r[t])}drawTile(t){if(!t)throw"tile cannot be null";this.drawSprite(z,t.sprite,t.x,t.y),t.book&&this.drawSprite(Y,lt,t.x,t.y),t.effectCounter>0&&(t.effectCounter--,this.drawSprite(H,t.effectIndex,t.x,t.y,t.effectCounter))}drawMonster(t){if(!t)throw"Monster cannot be null";if(t.teleportCounter>0)this.drawSprite(X,ut.MonsterLoad,t.getDisplayX(),t.getDisplayY());else{this.drawSprite(X,t.sprite,t.getDisplayX(),t.getDisplayY());for(let e=0;e<t.hp;e++)this.drawSprite(X,ut.HP,t.getDisplayX()+e%3*(5/16),t.getDisplayY()-Math.floor(e/3)*(5/16))}t.offsetX-=Math.sign(t.offsetX)*(1/8),t.offsetY-=Math.sign(t.offsetY)*(1/8)}drawSprite(t,e,r,s,i=0){if(t===H&&i&&i>0&&(this.ctx.globalAlpha=i/rt),e){const n=e[0];let o=e[1];t===X&&this.showAlternateSprites&&(o=1),this.ctx.drawImage(this.getSpriteSheet(t),16*n,16*o,16,16,r*et+this.shake.x,s*et+this.shake.y,et,et),t===H&&(!i||i<=0)&&(this.ctx.globalAlpha=1)}}clearCanvas(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}screenshake(){this.shake.amount&&this.shake.amount--;const t=Math.random()*Math.PI*2;this.shake.x=Math.round(Math.cos(t)*this.shake.amount),this.shake.y=Math.round(Math.sin(t)*this.shake.amount)}hideOverlays(){const t=document.getElementsByClassName("overlay");if(t)for(let e=0;e<t.length;e++)if(t[e]){t[e].style.display="none"}}showTitle(t){const e=document.getElementById("TitleOverlay");e&&(t&&t.length>0&&this.drawScores(t),e.style.display="block")}showGameWin(t){const e=document.getElementById("GameWinOverlay");e&&(t&&t.length>0&&this.drawScores(t),e.style.display="block")}showGameLose(t){const e=document.getElementById("GameLoseOverlay");e&&(t&&t.length>0&&this.drawScores(t),e.style.display="block")}updateSidebar(t,e,r){this.playerBooksElem.innerText=e.toString(),this.playerLocationElem.innerText=t.toString();const s=document.getElementById("spells");if(s){for(;s.hasChildNodes();)s.firstChild&&s.removeChild(s.firstChild);const t=document.createDocumentFragment();for(let e=0;e<Object.keys(r).length;e++){const s=document.createElement("button");s.className="spellButton",s.innerText="("+(e+1)+") "+(r[e].name||""),t.append(s)}s.appendChild(t)}}drawScores(t){const e=t.pop();void 0!==e&&(t.sort((function(t,e){return e.totalScore-t.totalScore})),t.unshift(e));const r=document.getElementsByClassName("scores");for(let e=0;e<r.length;e++){const s=r[e].children[1];if(s)for(;s.hasChildNodes();)s.firstChild&&s.removeChild(s.firstChild);const i=new DocumentFragment;for(let e=0;e<Math.min(10,t.length);e++){const r=document.createElement("tr"),s=document.createElement("td"),n=document.createElement("td"),o=document.createElement("td");s.innerHTML=t[e].run.toString(),n.innerHTML=t[e].score.toString(),o.innerHTML=t[e].totalScore.toString(),r.appendChild(s),r.appendChild(n),r.appendChild(o),i.appendChild(r)}s.appendChild(i)}}setShakeAmount(t){this.shake.amount=t}};Jt=Vt([E(),qt("design:paramtypes",[])],Jt);var Zt=function(t,e,r,s){var i,n=arguments.length,o=n<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,r):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,r,s);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(o=(n<3?i(o):n>3?i(e,r,o):i(e,r))||o);return n>3&&o&&Object.defineProperty(e,r,o),o},Qt=function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)};let $t=class{constructor(){k.register("IAudioPlayer",{useClass:ot}),k.register("ILevelGenerator",{useClass:Yt}),k.register("IMapper",{useClass:Ut}),k.register("IRenderer",{useClass:Jt}),this.game=k.resolve(Lt)}init(){this.game.init()}};$t=Zt([A(),Qt("design:paramtypes",[])],$t);var te=$t;export{te as default};
