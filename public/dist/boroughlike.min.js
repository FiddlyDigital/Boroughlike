var t,e;!function(t){!function(e){var i="object"==typeof global?global:"object"==typeof self?self:"object"==typeof this?this:Function("return this;")(),r=s(t);function s(t,e){return function(i,r){"function"!=typeof t[i]&&Object.defineProperty(t,i,{configurable:!0,writable:!0,value:r}),e&&e(i,r)}}void 0===i.Reflect?i.Reflect=t:r=s(i.Reflect,r),function(t){var e=Object.prototype.hasOwnProperty,i="function"==typeof Symbol,r=i&&void 0!==Symbol.toPrimitive?Symbol.toPrimitive:"@@toPrimitive",s=i&&void 0!==Symbol.iterator?Symbol.iterator:"@@iterator",n="function"==typeof Object.create,o={__proto__:[]}instanceof Array,a=!n&&!o,l={create:n?function(){return rt(Object.create(null))}:o?function(){return rt({__proto__:null})}:function(){return rt({})},has:a?function(t,i){return e.call(t,i)}:function(t,e){return e in t},get:a?function(t,i){return e.call(t,i)?t[i]:void 0}:function(t,e){return t[e]}},h=Object.getPrototypeOf(Function),c="object"==typeof process&&process.env&&"true"===process.env.REFLECT_METADATA_USE_MAP_POLYFILL,u=c||"function"!=typeof Map||"function"!=typeof Map.prototype.entries?tt():Map,p=c||"function"!=typeof Set||"function"!=typeof Set.prototype.entries?et():Set,f=new(c||"function"!=typeof WeakMap?it():WeakMap);function d(t,e,i,r){if(j(i)){if(!X(t))throw new TypeError;if(!z(e))throw new TypeError;return M(t,e)}if(!X(t))throw new TypeError;if(!N(e))throw new TypeError;if(!N(r)&&!j(r)&&!D(r))throw new TypeError;return D(r)&&(r=void 0),_(t,e,i=Y(i),r)}function y(t,e){function i(i,r){if(!N(i))throw new TypeError;if(!j(r)&&!V(r))throw new TypeError;P(t,e,i,r)}return i}function g(t,e,i,r){if(!N(i))throw new TypeError;return j(r)||(r=Y(r)),P(t,e,i,r)}function m(t,e,i){if(!N(e))throw new TypeError;return j(i)||(i=Y(i)),R(t,e,i)}function v(t,e,i){if(!N(e))throw new TypeError;return j(i)||(i=Y(i)),k(t,e,i)}function w(t,e,i){if(!N(e))throw new TypeError;return j(i)||(i=Y(i)),A(t,e,i)}function b(t,e,i){if(!N(e))throw new TypeError;return j(i)||(i=Y(i)),E(t,e,i)}function S(t,e){if(!N(t))throw new TypeError;return j(e)||(e=Y(e)),O(t,e)}function x(t,e){if(!N(t))throw new TypeError;return j(e)||(e=Y(e)),C(t,e)}function T(t,e,i){if(!N(e))throw new TypeError;j(i)||(i=Y(i));var r=L(e,i,!1);if(j(r))return!1;if(!r.delete(t))return!1;if(r.size>0)return!0;var s=f.get(e);return s.delete(i),s.size>0||f.delete(e),!0}function M(t,e){for(var i=t.length-1;i>=0;--i){var r=(0,t[i])(e);if(!j(r)&&!D(r)){if(!z(r))throw new TypeError;e=r}}return e}function _(t,e,i,r){for(var s=t.length-1;s>=0;--s){var n=(0,t[s])(e,i,r);if(!j(n)&&!D(n)){if(!N(n))throw new TypeError;r=n}}return r}function L(t,e,i){var r=f.get(t);if(j(r)){if(!i)return;r=new u,f.set(t,r)}var s=r.get(e);if(j(s)){if(!i)return;s=new u,r.set(e,s)}return s}function R(t,e,i){if(k(t,e,i))return!0;var r=Q(e);return!D(r)&&R(t,r,i)}function k(t,e,i){var r=L(e,i,!1);return!j(r)&&H(r.has(t))}function A(t,e,i){if(k(t,e,i))return E(t,e,i);var r=Q(e);return D(r)?void 0:A(t,r,i)}function E(t,e,i){var r=L(e,i,!1);if(!j(r))return r.get(t)}function P(t,e,i,r){L(i,r,!0).set(t,e)}function O(t,e){var i=C(t,e),r=Q(t);if(null===r)return i;var s=O(r,e);if(s.length<=0)return i;if(i.length<=0)return s;for(var n=new p,o=[],a=0,l=i;a<l.length;a++){var h=l[a];n.has(h)||(n.add(h),o.push(h))}for(var c=0,u=s;c<u.length;c++){h=u[c];n.has(h)||(n.add(h),o.push(h))}return o}function C(t,e){var i=[],r=L(t,e,!1);if(j(r))return i;for(var s=$(r.keys()),n=0;;){var o=J(s);if(!o)return i.length=n,i;var a=q(o);try{i[n]=a}catch(t){try{Z(s)}finally{throw t}}n++}}function I(t){if(null===t)return 1;switch(typeof t){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return null===t?1:6;default:return 6}}function j(t){return void 0===t}function D(t){return null===t}function F(t){return"symbol"==typeof t}function N(t){return"object"==typeof t?null!==t:"function"==typeof t}function W(t,e){switch(I(t)){case 0:case 1:case 2:case 3:case 4:case 5:return t}var i=3===e?"string":5===e?"number":"default",s=K(t,r);if(void 0!==s){var n=s.call(t,i);if(N(n))throw new TypeError;return n}return B(t,"default"===i?"number":i)}function B(t,e){if("string"===e){var i=t.toString;if(G(i))if(!N(s=i.call(t)))return s;if(G(r=t.valueOf))if(!N(s=r.call(t)))return s}else{var r;if(G(r=t.valueOf))if(!N(s=r.call(t)))return s;var s,n=t.toString;if(G(n))if(!N(s=n.call(t)))return s}throw new TypeError}function H(t){return!!t}function U(t){return""+t}function Y(t){var e=W(t,3);return F(e)?e:U(e)}function X(t){return Array.isArray?Array.isArray(t):t instanceof Object?t instanceof Array:"[object Array]"===Object.prototype.toString.call(t)}function G(t){return"function"==typeof t}function z(t){return"function"==typeof t}function V(t){switch(I(t)){case 3:case 4:return!0;default:return!1}}function K(t,e){var i=t[e];if(null!=i){if(!G(i))throw new TypeError;return i}}function $(t){var e=K(t,s);if(!G(e))throw new TypeError;var i=e.call(t);if(!N(i))throw new TypeError;return i}function q(t){return t.value}function J(t){var e=t.next();return!e.done&&e}function Z(t){var e=t.return;e&&e.call(t)}function Q(t){var e=Object.getPrototypeOf(t);if("function"!=typeof t||t===h)return e;if(e!==h)return e;var i=t.prototype,r=i&&Object.getPrototypeOf(i);if(null==r||r===Object.prototype)return e;var s=r.constructor;return"function"!=typeof s||s===t?e:s}function tt(){var t={},e=[],i=function(){function t(t,e,i){this._index=0,this._keys=t,this._values=e,this._selector=i}return t.prototype["@@iterator"]=function(){return this},t.prototype[s]=function(){return this},t.prototype.next=function(){var t=this._index;if(t>=0&&t<this._keys.length){var i=this._selector(this._keys[t],this._values[t]);return t+1>=this._keys.length?(this._index=-1,this._keys=e,this._values=e):this._index++,{value:i,done:!1}}return{value:void 0,done:!0}},t.prototype.throw=function(t){throw this._index>=0&&(this._index=-1,this._keys=e,this._values=e),t},t.prototype.return=function(t){return this._index>=0&&(this._index=-1,this._keys=e,this._values=e),{value:t,done:!0}},t}();return function(){function e(){this._keys=[],this._values=[],this._cacheKey=t,this._cacheIndex=-2}return Object.defineProperty(e.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),e.prototype.has=function(t){return this._find(t,!1)>=0},e.prototype.get=function(t){var e=this._find(t,!1);return e>=0?this._values[e]:void 0},e.prototype.set=function(t,e){var i=this._find(t,!0);return this._values[i]=e,this},e.prototype.delete=function(e){var i=this._find(e,!1);if(i>=0){for(var r=this._keys.length,s=i+1;s<r;s++)this._keys[s-1]=this._keys[s],this._values[s-1]=this._values[s];return this._keys.length--,this._values.length--,e===this._cacheKey&&(this._cacheKey=t,this._cacheIndex=-2),!0}return!1},e.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=t,this._cacheIndex=-2},e.prototype.keys=function(){return new i(this._keys,this._values,r)},e.prototype.values=function(){return new i(this._keys,this._values,n)},e.prototype.entries=function(){return new i(this._keys,this._values,o)},e.prototype["@@iterator"]=function(){return this.entries()},e.prototype[s]=function(){return this.entries()},e.prototype._find=function(t,e){return this._cacheKey!==t&&(this._cacheIndex=this._keys.indexOf(this._cacheKey=t)),this._cacheIndex<0&&e&&(this._cacheIndex=this._keys.length,this._keys.push(t),this._values.push(void 0)),this._cacheIndex},e}();function r(t,e){return t}function n(t,e){return e}function o(t,e){return[t,e]}}function et(){return function(){function t(){this._map=new u}return Object.defineProperty(t.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),t.prototype.has=function(t){return this._map.has(t)},t.prototype.add=function(t){return this._map.set(t,t),this},t.prototype.delete=function(t){return this._map.delete(t)},t.prototype.clear=function(){this._map.clear()},t.prototype.keys=function(){return this._map.keys()},t.prototype.values=function(){return this._map.values()},t.prototype.entries=function(){return this._map.entries()},t.prototype["@@iterator"]=function(){return this.keys()},t.prototype[s]=function(){return this.keys()},t}()}function it(){var t=16,i=l.create(),r=s();return function(){function t(){this._key=s()}return t.prototype.has=function(t){var e=n(t,!1);return void 0!==e&&l.has(e,this._key)},t.prototype.get=function(t){var e=n(t,!1);return void 0!==e?l.get(e,this._key):void 0},t.prototype.set=function(t,e){return n(t,!0)[this._key]=e,this},t.prototype.delete=function(t){var e=n(t,!1);return void 0!==e&&delete e[this._key]},t.prototype.clear=function(){this._key=s()},t}();function s(){var t;do{t="@@WeakMap@@"+h()}while(l.has(i,t));return i[t]=!0,t}function n(t,i){if(!e.call(t,r)){if(!i)return;Object.defineProperty(t,r,{value:l.create()})}return t[r]}function o(t,e){for(var i=0;i<e;++i)t[i]=255*Math.random()|0;return t}function a(t){return"function"==typeof Uint8Array?"undefined"!=typeof crypto?crypto.getRandomValues(new Uint8Array(t)):"undefined"!=typeof msCrypto?msCrypto.getRandomValues(new Uint8Array(t)):o(new Uint8Array(t),t):o(new Array(t),t)}function h(){var e=a(t);e[6]=79&e[6]|64,e[8]=191&e[8]|128;for(var i="",r=0;r<t;++r){var s=e[r];4!==r&&6!==r&&8!==r||(i+="-"),s<16&&(i+="0"),i+=s.toString(16).toLowerCase()}return i}}function rt(t){return t.__=void 0,delete t.__,t}t("decorate",d),t("metadata",y),t("defineMetadata",g),t("hasMetadata",m),t("hasOwnMetadata",v),t("getMetadata",w),t("getOwnMetadata",b),t("getMetadataKeys",S),t("getOwnMetadataKeys",x),t("deleteMetadata",T)}(r)}()}(t||(t={})),function(t){t[t.Transient=0]="Transient",t[t.Singleton=1]="Singleton",t[t.ResolutionScoped=2]="ResolutionScoped",t[t.ContainerScoped=3]="ContainerScoped"}(e||(e={}));var i=e,r=function(t,e){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])},r(t,e)};function s(t,e){function i(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}function n(t,e,i,r){return new(i||(i=Promise))((function(s,n){function o(t){try{l(r.next(t))}catch(t){n(t)}}function a(t){try{l(r.throw(t))}catch(t){n(t)}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,a)}l((r=r.apply(t,e||[])).next())}))}function o(t,e){var i,r,s,n,o={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return n={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function a(n){return function(a){return function(n){if(i)throw new TypeError("Generator is already executing.");for(;o;)try{if(i=1,r&&(s=2&n[0]?r.return:n[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,n[1])).done)return s;switch(r=0,s&&(n=[2&n[0],s.value]),n[0]){case 0:case 1:s=n;break;case 4:return o.label++,{value:n[1],done:!1};case 5:o.label++,r=n[1],n=[0];continue;case 7:n=o.ops.pop(),o.trys.pop();continue;default:if(!(s=o.trys,(s=s.length>0&&s[s.length-1])||6!==n[0]&&2!==n[0])){o=0;continue}if(3===n[0]&&(!s||n[1]>s[0]&&n[1]<s[3])){o.label=n[1];break}if(6===n[0]&&o.label<s[1]){o.label=s[1],s=n;break}if(s&&o.label<s[2]){o.label=s[2],o.ops.push(n);break}s[2]&&o.ops.pop(),o.trys.pop();continue}n=e.call(t,o)}catch(t){n=[6,t],r=0}finally{i=s=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,a])}}}function a(t){var e="function"==typeof Symbol&&Symbol.iterator,i=e&&t[e],r=0;if(i)return i.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function l(t,e){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var r,s,n=i.call(t),o=[];try{for(;(void 0===e||e-- >0)&&!(r=n.next()).done;)o.push(r.value)}catch(t){s={error:t}}finally{try{r&&!r.done&&(i=n.return)&&i.call(n)}finally{if(s)throw s.error}}return o}function h(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(l(arguments[e]));return t}var c="injectionTokens";function u(t){return!!t.useClass}function p(t){return!!t.useFactory}var f=function(){function t(t){this.wrap=t,this.reflectMethods=["get","getPrototypeOf","setPrototypeOf","getOwnPropertyDescriptor","defineProperty","has","set","deleteProperty","apply","construct","ownKeys"]}return t.prototype.createProxy=function(t){var e,i=this,r=!1;return new Proxy({},this.createHandler((function(){return r||(e=t(i.wrap()),r=!0),e})))},t.prototype.createHandler=function(t){var e={};return this.reflectMethods.forEach((function(i){e[i]=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return e[0]=t(),Reflect[i].apply(void 0,h(e))}})),e},t}();function d(t){return"string"==typeof t||"symbol"==typeof t}function y(t){return"object"==typeof t&&"token"in t&&"transform"in t}function g(t){return!!t.useToken}function m(t){return null!=t.useValue}var v=function(){function t(){this._registryMap=new Map}return t.prototype.entries=function(){return this._registryMap.entries()},t.prototype.getAll=function(t){return this.ensure(t),this._registryMap.get(t)},t.prototype.get=function(t){this.ensure(t);var e=this._registryMap.get(t);return e[e.length-1]||null},t.prototype.set=function(t,e){this.ensure(t),this._registryMap.get(t).push(e)},t.prototype.setAll=function(t,e){this._registryMap.set(t,e)},t.prototype.has=function(t){return this.ensure(t),this._registryMap.get(t).length>0},t.prototype.clear=function(){this._registryMap.clear()},t.prototype.ensure=function(t){this._registryMap.has(t)||this._registryMap.set(t,[])},t}(),w=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return s(e,t),e}(v),b=function(){this.scopedResolutions=new Map};function S(t,e,i){var r,s,n=l(t.toString().match(/constructor\(([\w, ]+)\)/)||[],2)[1],o=function(t,e){return null===t?"at position #"+e:'"'+t.split(",")[e].trim()+'" at position #'+e}(void 0===n?null:n,e);return r="Cannot inject the dependency "+o+' of "'+t.name+'" constructor. Reason:',void 0===s&&(s="    "),h([r],i.message.split("\n").map((function(t){return s+t}))).join("\n")}var x=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return s(e,t),e}(v),T=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return s(e,t),e}(v),M=function(){this.preResolution=new x,this.postResolution=new T},_=new Map,L=function(){function t(t){this.parent=t,this._registry=new w,this.interceptors=new M,this.disposed=!1,this.disposables=new Set}return t.prototype.register=function(t,e,r){var s;if(void 0===r&&(r={lifecycle:i.Transient}),this.ensureNotDisposed(),s=function(t){return u(t)||m(t)||g(t)||p(t)}(e)?e:{useClass:e},g(s))for(var n=[t],o=s;null!=o;){var a=o.useToken;if(n.includes(a))throw new Error("Token registration cycle detected! "+h(n,[a]).join(" -> "));n.push(a);var l=this._registry.get(a);o=l&&g(l.provider)?l.provider:null}if((r.lifecycle===i.Singleton||r.lifecycle==i.ContainerScoped||r.lifecycle==i.ResolutionScoped)&&(m(s)||p(s)))throw new Error('Cannot use lifecycle "'+i[r.lifecycle]+'" with ValueProviders or FactoryProviders');return this._registry.set(t,{provider:s,options:r}),this},t.prototype.registerType=function(t,e){return this.ensureNotDisposed(),d(e)?this.register(t,{useToken:e}):this.register(t,{useClass:e})},t.prototype.registerInstance=function(t,e){return this.ensureNotDisposed(),this.register(t,{useValue:e})},t.prototype.registerSingleton=function(t,e){if(this.ensureNotDisposed(),d(t)){if(d(e))return this.register(t,{useToken:e},{lifecycle:i.Singleton});if(e)return this.register(t,{useClass:e},{lifecycle:i.Singleton});throw new Error('Cannot register a type name as a singleton without a "to" token')}var r=t;return e&&!d(e)&&(r=e),this.register(t,{useClass:r},{lifecycle:i.Singleton})},t.prototype.resolve=function(t,e){void 0===e&&(e=new b),this.ensureNotDisposed();var i=this.getRegistration(t);if(!i&&d(t))throw new Error('Attempted to resolve unregistered dependency token: "'+t.toString()+'"');if(this.executePreResolutionInterceptor(t,"Single"),i){var r=this.resolveRegistration(i,e);return this.executePostResolutionInterceptor(t,r,"Single"),r}if(function(t){return"function"==typeof t||t instanceof f}(t)){r=this.construct(t,e);return this.executePostResolutionInterceptor(t,r,"Single"),r}throw new Error("Attempted to construct an undefined constructor. Could mean a circular dependency problem. Try using `delay` function.")},t.prototype.executePreResolutionInterceptor=function(t,e){var i,r;if(this.interceptors.preResolution.has(t)){var s=[];try{for(var n=a(this.interceptors.preResolution.getAll(t)),o=n.next();!o.done;o=n.next()){var l=o.value;"Once"!=l.options.frequency&&s.push(l),l.callback(t,e)}}catch(t){i={error:t}}finally{try{o&&!o.done&&(r=n.return)&&r.call(n)}finally{if(i)throw i.error}}this.interceptors.preResolution.setAll(t,s)}},t.prototype.executePostResolutionInterceptor=function(t,e,i){var r,s;if(this.interceptors.postResolution.has(t)){var n=[];try{for(var o=a(this.interceptors.postResolution.getAll(t)),l=o.next();!l.done;l=o.next()){var h=l.value;"Once"!=h.options.frequency&&n.push(h),h.callback(t,e,i)}}catch(t){r={error:t}}finally{try{l&&!l.done&&(s=o.return)&&s.call(o)}finally{if(r)throw r.error}}this.interceptors.postResolution.setAll(t,n)}},t.prototype.resolveRegistration=function(t,e){if(this.ensureNotDisposed(),t.options.lifecycle===i.ResolutionScoped&&e.scopedResolutions.has(t))return e.scopedResolutions.get(t);var r,s=t.options.lifecycle===i.Singleton,n=t.options.lifecycle===i.ContainerScoped,o=s||n;return r=m(t.provider)?t.provider.useValue:g(t.provider)?o?t.instance||(t.instance=this.resolve(t.provider.useToken,e)):this.resolve(t.provider.useToken,e):u(t.provider)?o?t.instance||(t.instance=this.construct(t.provider.useClass,e)):this.construct(t.provider.useClass,e):p(t.provider)?t.provider.useFactory(this):this.construct(t.provider,e),t.options.lifecycle===i.ResolutionScoped&&e.scopedResolutions.set(t,r),r},t.prototype.resolveAll=function(t,e){var i=this;void 0===e&&(e=new b),this.ensureNotDisposed();var r=this.getAllRegistrations(t);if(!r&&d(t))throw new Error('Attempted to resolve unregistered dependency token: "'+t.toString()+'"');if(this.executePreResolutionInterceptor(t,"All"),r){var s=r.map((function(t){return i.resolveRegistration(t,e)}));return this.executePostResolutionInterceptor(t,s,"All"),s}var n=[this.construct(t,e)];return this.executePostResolutionInterceptor(t,n,"All"),n},t.prototype.isRegistered=function(t,e){return void 0===e&&(e=!1),this.ensureNotDisposed(),this._registry.has(t)||e&&(this.parent||!1)&&this.parent.isRegistered(t,!0)},t.prototype.reset=function(){this.ensureNotDisposed(),this._registry.clear(),this.interceptors.preResolution.clear(),this.interceptors.postResolution.clear()},t.prototype.clearInstances=function(){var t,e;this.ensureNotDisposed();try{for(var i=a(this._registry.entries()),r=i.next();!r.done;r=i.next()){var s=l(r.value,2),n=s[0],o=s[1];this._registry.setAll(n,o.filter((function(t){return!m(t.provider)})).map((function(t){return t.instance=void 0,t})))}}catch(e){t={error:e}}finally{try{r&&!r.done&&(e=i.return)&&e.call(i)}finally{if(t)throw t.error}}},t.prototype.createChildContainer=function(){var e,r;this.ensureNotDisposed();var s=new t(this);try{for(var n=a(this._registry.entries()),o=n.next();!o.done;o=n.next()){var h=l(o.value,2),c=h[0],u=h[1];u.some((function(t){return t.options.lifecycle===i.ContainerScoped}))&&s._registry.setAll(c,u.map((function(t){return t.options.lifecycle===i.ContainerScoped?{provider:t.provider,options:t.options}:t})))}}catch(t){e={error:t}}finally{try{o&&!o.done&&(r=n.return)&&r.call(n)}finally{if(e)throw e.error}}return s},t.prototype.beforeResolution=function(t,e,i){void 0===i&&(i={frequency:"Always"}),this.interceptors.preResolution.set(t,{callback:e,options:i})},t.prototype.afterResolution=function(t,e,i){void 0===i&&(i={frequency:"Always"}),this.interceptors.postResolution.set(t,{callback:e,options:i})},t.prototype.dispose=function(){return n(this,void 0,void 0,(function(){var t;return o(this,(function(e){switch(e.label){case 0:return this.disposed=!0,t=[],this.disposables.forEach((function(e){var i=e.dispose();i&&t.push(i)})),[4,Promise.all(t)];case 1:return e.sent(),[2]}}))}))},t.prototype.getRegistration=function(t){return this.isRegistered(t)?this._registry.get(t):this.parent?this.parent.getRegistration(t):null},t.prototype.getAllRegistrations=function(t){return this.isRegistered(t)?this._registry.getAll(t):this.parent?this.parent.getAllRegistrations(t):null},t.prototype.construct=function(t,e){var i=this;if(t instanceof f)return t.createProxy((function(t){return i.resolve(t,e)}));var r,s=function(){var r=_.get(t);if(!r||0===r.length){if(0===t.length)return new t;throw new Error('TypeInfo not known for "'+t.name+'"')}var s=r.map(i.resolveParams(e,t));return new(t.bind.apply(t,h([void 0],s)))}();return"function"!=typeof(r=s).dispose||r.dispose.length>0||this.disposables.add(s),s},t.prototype.resolveParams=function(t,e){var i=this;return function(r,s){var n,o,a,l;try{return"object"==typeof(l=r)&&"token"in l&&"multiple"in l?y(r)?r.multiple?(n=i.resolve(r.transform)).transform.apply(n,h([i.resolveAll(r.token)],r.transformArgs)):(o=i.resolve(r.transform)).transform.apply(o,h([i.resolve(r.token,t)],r.transformArgs)):r.multiple?i.resolveAll(r.token):i.resolve(r.token,t):y(r)?(a=i.resolve(r.transform,t)).transform.apply(a,h([i.resolve(r.token,t)],r.transformArgs)):i.resolve(r,t)}catch(t){throw new Error(S(e,s,t))}}},t.prototype.ensureNotDisposed=function(){if(this.disposed)throw new Error("This container has been disposed, you cannot interact with a disposed container")},t}(),R=new L;function k(t){return e=t,function(t,r,s){var n=Reflect.getOwnMetadata(c,t)||{};n[s]=i?{token:e,transform:i.transformToken,transformArgs:i.args||[]}:e,Reflect.defineMetadata(c,n,t)};var e,i}function A(){return function(t){_.set(t,function(t){var e=Reflect.getMetadata("design:paramtypes",t)||[],i=Reflect.getOwnMetadata(c,t)||{};return Object.keys(i).forEach((function(t){e[+t]=i[t]})),e}(t))}}function E(){return function(t){A()(t),R.registerSingleton(t)}}if("undefined"==typeof Reflect||!Reflect.getMetadata)throw new Error("tsyringe requires a reflect polyfill. Please add 'import \"reflect-metadata\"' to the top of your entry point.");const P="AssetsLoaded",O="KeyPress",C="PlayerLose",I="PlayerWin",j="GameOver",D="GameWin",F="Loading",N="Running",W="Title",B={BOOK:"book.wav",MONSTERHIT:"hit2.wav",NEWLEVEL:"newLevel.wav",PLAYERHIT:"hit1.wav",SPELL:"spell.wav"},H="effect",U="item",Y="Monster",X="tile",G="Library",z="N",V="E",K="S",$="W",q="NEXTLEVEL",J="PREVLEVEL",Z="PLAYSOUND",Q="SETSHAKE";class tt{constructor(){this.subscriptions=[]}static getInstance(){return tt.instance||(tt.instance=new tt),tt.instance}subscribe(t,e){this.subscriptions[t]||(this.subscriptions[t]=[]),this.subscriptions[t].push(e)}publish(t,e){this.subscriptions[t]&&this.subscriptions[t].forEach((t=>{t&&t(e)}))}}const et="assets/images/",it=16,rt=1e3/60,st=48;var nt=function(t,e,i,r){var s,n=arguments.length,o=n<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,i,r);else for(var a=t.length-1;a>=0;a--)(s=t[a])&&(o=(n<3?s(o):n>3?s(e,i,o):s(e,i))||o);return n>3&&o&&Object.defineProperty(e,i,o),o},ot=function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)};let at=class{constructor(){this.sounds={},this.initSounds(),tt.getInstance().subscribe(Z,this.playSound.bind(this))}initSounds(){for(const t of Object.values(B))this.sounds[t]=new Audio(`assets/sounds/${t}`)}playSound(t){t&&this.sounds[t]&&(this.sounds[t].currentTime=0,this.sounds[t].play())}};at=nt([E(),ot("design:paramtypes",[])],at);class lt{constructor(t,e){this.stateMatrix=t,this.currentState={name:""},this.previousState=null,this.enterState(e)}triggerEvent(t){const e=this.currentState.getNewState(t);e&&this.enterState(e)}enterState(t){t!==this.currentState.name&&(this.currentState.onExit&&this.currentState.onExit(),this.previousState=this.currentState,this.currentState=this.stateMatrix[t],this.currentState.onEnter&&this.currentState.onEnter())}}class ht{constructor(t,e,i,r){this.name=t||"",this.transformations=e||{},this.onEnter=i,this.onExit=r}getNewState(t){return t=t||"",this.transformations[t]?this.transformations[t]:null}}class ct{constructor(t,e,i,r){this.score=0,this.run=1,this.totalScore=0,this.active=!1,this.score=null!=t?t:0,this.run=null!=e?e:1,this.totalScore=null!=i?i:0,this.active=null!=r&&r}}const ut={Heal:[0,0],Flame:[1,0],Bolt_Horizontal:[2,0],Bolt_Vertical:[3,0]},pt=[0,0],ft={Player:[0,0],Player_Dead:[1,0],Bird:[2,0],Snake:[3,0],Tank:[4,0],Eater:[5,0],Jester:[6,0],HP:[7,0],MonsterLoad:[8,0],Turret_N:[9,0],Turret_E:[10,0],Turret_S:[11,0],Turret_W:[12,0]},dt={StairDown:[1,0],StairUp:[1,1],SpikePit:[2,0],FountainActive:[3,0],FountainInactive:[3,1],Wall:[0,2],Wall_L:[1,2],Wall_R:[2,2],Wall_LR:[3,2],Wall_T:[0,3],Wall_B:[1,3],Wall_TB:[2,3],Wall_LT:[3,3],Wall_RT:[0,4],Wall_LRT:[1,4],Wall_LB:[2,4],Wall_RB:[3,4],Wall_LRB:[0,5],Wall_LTB:[1,5],Wall_RTB:[2,5],Wall_LRTB:[3,5],Floor:[0,6],Floor_L:[1,6],Floor_R:[2,6],Floor_LR:[3,6],Floor_T:[0,7],Floor_B:[1,7],Floor_TB:[2,7],Floor_LT:[3,7],Floor_RT:[0,8],Floor_LRT:[1,8],Floor_LB:[2,8],Floor_RB:[3,8],Floor_LRB:[0,9],Floor_LTB:[1,9],Floor_RTB:[2,9],Floor_LRTB:[3,9]};class yt{constructor(t,e){this.caster=t,this.name=e}cast(){tt.getInstance().publish(Z,B.SPELL)}boltTravel(t,e,i,r){if(null===t.tile)return;let s=t.tile;for(;;){const t=s.getNeighbor(e[0],e[1]);if(!t||!t.passable)break;s=t,s.monster&&s.monster.hit(r),s.setEffect(i)}}}class gt{constructor(t,e,i,r,s){this.visible=!1,this.seen=!1,this.book=!1,this.effectIndex=null,this.effectCounter=0,this.stepEffectActive=!1,this.monster=null,this.map=t,this.x=e,this.y=i,this.sprite=r,this.passable=s}dist(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}getNeighbor(t,e){return this.map.getTile(this.x+t,this.y+e)}getAdjacentNeighbors(){return[this.getNeighbor(0,-1),this.getNeighbor(0,1),this.getNeighbor(-1,0),this.getNeighbor(1,0)]}getNeighborChain(t){let e=[0,0];switch(t){case z:e=[0,-1];break;case K:e=[0,1];break;case V:e=[1,0];break;case $:e=[-1,0];break;default:throw"Direction didn't have a valid value."}const i=[];let r=this.map.getTile(this.x,this.y);for(;null!=r;)r=r.getNeighbor(e[0],e[1]),r&&r.passable?i.push(r):r=null;return i}getAdjacentPassableNeighbors(){return this.getAdjacentNeighbors().filter((t=>t&&t.passable))}setEffect(t){this.effectIndex=t,this.effectCounter=30}}class mt extends gt{constructor(t,e,i){super(t,e,i,dt.Floor,!0)}stepOn(t){this.book&&t&&t.isPlayer&&(this.book=!1)}activate(t){console.log(t)}}const vt=[class extends yt{constructor(t){super(t,"WOOP")}cast(){if(null===this.caster.tile)return;super.cast();const t=this.caster.tile.map.randomPassableTile();t&&this.caster.setTile(t)}},class extends yt{constructor(t){super(t,"Quake")}cast(){if(null!==this.caster.tile){super.cast();for(let t=0;t<it;t++)for(let e=0;e<it;e++){const i=this.caster.tile.map.getTile(t,e);if(i&&i.monster&&i.monster!=this.caster){const t=4-i.getAdjacentPassableNeighbors().length;i.monster.hit(2*t)}}tt.getInstance().publish(Q,20)}}},class extends yt{constructor(t){super(t,"Tornado")}cast(){if(null===this.caster.tile)return;super.cast();const t=this.caster.tile.map.getMonsters();for(let e=0;e<t.length;e++){const i=t[e];if(i){const t=this.caster.tile.map.randomPassableTile();t&&(i.setTile(t),i.teleportCounter=2)}}}},class extends yt{constructor(t){super(t,"AURA")}cast(){null!==this.caster.tile&&(super.cast(),this.caster.tile.getAdjacentNeighbors().forEach((function(t){t&&(t.setEffect(ut.Heal),t.monster&&t.monster.heal(1))})),this.caster.tile.setEffect(ut.Heal),this.caster.heal(3))}},class extends yt{constructor(t){super(t,"DASH")}cast(){if(null===this.caster.tile)return;super.cast();let t=this.caster.tile;for(;;){const e=t.getNeighbor(this.caster.lastMove[0],this.caster.lastMove[1]);if(!e||!e.passable||e.monster)break;t=e}this.caster.tile!=t&&(this.caster.setTile(t),t.getAdjacentNeighbors().forEach((t=>{t&&t.monster&&(t.setEffect(ut.Flame),t.monster.stunned=!0,t.monster.hit(1))})))}},class extends yt{constructor(t){super(t,"FLATTEN")}cast(){if(null!==this.caster.tile){super.cast();for(let t=1;t<15;t++)for(let e=1;e<15;e++){const i=this.caster.tile.map.getTile(t,e);i&&!i.passable&&i.map.replaceTile(t,e,new mt(i.map,t,e))}this.caster.tile.setEffect(ut.Flame),this.caster.heal(2)}}},class extends yt{constructor(t){super(t,"ALCHEMY")}cast(){null!==this.caster.tile&&(super.cast(),this.caster.tile.getAdjacentNeighbors().forEach((function(t){t&&!t.passable&&t.map.replaceTile(t.x,t.y,new mt(t.map,t.x,t.y))})))}},class extends yt{constructor(t){super(t,"BOLT")}cast(){null!==this.caster.tile&&(super.cast(),super.boltTravel(this.caster,this.caster.lastMove,[15+Math.abs(this.caster.lastMove[1])],4))}},class extends yt{constructor(t){super(t,"CROSS"),this.directions=[[0,-1],[0,1],[-1,0],[1,0]]}cast(){if(null!==this.caster.tile){super.cast();for(let t=0;t<this.directions.length;t++){const e=0==Math.abs(this.directions[t][1])?ut.Bolt_Horizontal:ut.Bolt_Vertical;super.boltTravel(this.caster,this.directions[t],e,2)}}}},class extends yt{constructor(t){super(t,"EX"),this.directions=[[-1,-1],[-1,1],[1,-1],[1,1]]}cast(){if(null!==this.caster.tile){super.cast();for(let t=0;t<this.directions.length;t++)super.boltTravel(this.caster,this.directions[t],ut.Flame,3)}}}];function wt(t,e){return Math.floor(Math.random()*(e-t+1))+t}function bt(t){let e,i;for(let r=1;r<t.length;r++)i=wt(0,r),e=t[r],t[r]=t[i],t[i]=e;return t}class St{constructor(t,e,i){this.isPlayer=!1,this.stunned=!1,this.attackedThisTurn=!1,this.tile=t,this.isPlayer=!1,this.stunned=!1,this.attackedThisTurn=!1,null!==t&&this.setTile(t),this.sprite=e,this.hp=i,this.teleportCounter=2,this.offsetX=0,this.offsetY=0,this.lastMove=[0,0],this.hitSFX=B.MONSTERHIT}heal(t){this.hp=Math.min(6,this.hp+t),tt.getInstance().publish(Z,B.PLAYERHEAL)}isDead(){return 0==this.hp}tickUpdate(){this.teleportCounter--,this.stunned||this.teleportCounter>0?this.stunned=!1:this.act()}act(){if(null===this.tile)return;const t=this.tile.getAdjacentPassableNeighbors().filter((t=>t&&(!t.monster||t.monster.isPlayer)));t.length&&(t.sort(((t,e)=>t.dist(this.tile)-e.dist(this.tile))),this.tryMove(t[0].x-this.tile.x,t[0].y-this.tile.y))}getDisplayX(){return null===this.tile?-1:this.tile.x+this.offsetX}getDisplayY(){return null===this.tile?-1:this.tile.y+this.offsetY}tryMove(t,e){if(null===this.tile)return!1;const i=this.tile.getNeighbor(t,e);return!(!i||!i.passable)&&(this.lastMove=[t,e],i.monster?this.isPlayer!=i.monster.isPlayer&&(this.attackedThisTurn=!0,i.monster.stunned=!0,i.monster.hit(1),tt.getInstance().publish(Q,5),this.offsetX=(i.x-this.tile.x)/2,this.offsetY=(i.y-this.tile.y)/2):this.setTile(i),!0)}hit(t){tt.getInstance().publish(Z,this.hitSFX),this.hp-=t,this.hp<=0&&(this.die(),this.tile instanceof mt&&(this.tile.book=!0))}die(){null!==this.tile&&(this.tile.monster=null),this.isPlayer&&(this.sprite=ft.Player_Dead)}setTile(t,e=!1){null!==this.tile&&(this.tile.monster=null,e?(this.offsetX=0,this.offsetY=0):(this.offsetX=this.tile.x-t.x,this.offsetY=this.tile.y-t.y)),this.tile=t,t.monster=this,t.stepOn(this)}}class xt extends St{constructor(t){super(t,ft.Player,3),this.score=0,this.hp=3,this.isPlayer=!0,this.teleportCounter=0,this.spells=bt(vt)[0],this.hitSFX=B.PLAYERHIT}tickUpdate(){}activateTile(){this.tile&&this.tile.activate(this)}}var Tt=function(t,e,i,r){var s,n=arguments.length,o=n<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,i,r);else for(var a=t.length-1;a>=0;a--)(s=t[a])&&(o=(n<3?s(o):n>3?s(e,i,o):s(e,i))||o);return n>3&&o&&Object.defineProperty(e,i,o),o},Mt=function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},_t=function(t,e){return function(i,r){e(i,r,t)}};let Lt=class{constructor(t,e,i){this.audioPlayer=t,this.mapper=e,this.renderer=i,this.localStorage={},this.level=1,this.player=new xt(null),this.numSpells=1,this.score=0,this.spawnCounter=0,this.spawnRate=15,this.sidebarNeedsUpdate=!1;const r={Loading:new ht(F,{AssetsLoaded:W},this.loadAssets.bind(this),null),Title:new ht(W,{KeyPress:N},this.showTitle.bind(this),null),Running:new ht(N,{PlayerLose:j,PlayerWin:D},this.startGame.bind(this),null),GameOver:new ht(j,{KeyPress:W},this.showGameLose.bind(this),null),GameWin:new ht(D,{KeyPress:W},this.showGameWin.bind(this),null)};this.FSM=new lt(r,F),this.lastAnimateUpdate=(new Date).getTime()}init(){this.addEventHandlers(),requestAnimationFrame(this.draw.bind(this))}loadAssets(){this.renderer.initSpriteSheet((()=>{this.FSM.triggerEvent(P)}))}addEventHandlers(){const t=this,e=document.querySelector("html");e&&(e.onkeydown=t.handleInteraction.bind(this)),window.addEventListener("touchstart",t.handleInteraction.bind(this)),window.addEventListener("mousedown",t.handleInteraction.bind(this)),tt.getInstance().subscribe(q,t.nextLevel.bind(this)),tt.getInstance().subscribe(J,t.prevLevel.bind(this))}handleInteraction(t){switch(this.FSM.currentState.name){case F:break;case N:t&&this.handleKeypress(t);break;default:this.FSM.triggerEvent(O)}}handleKeypress(t){if(!(t=t||window.event).defaultPrevented){switch(t.key){case"Up":case"ArrowUp":case"w":case"W":this.player.tryMove(0,-1);break;case"Down":case"ArrowDown":case"s":case"S":this.player.tryMove(0,1);break;case"Left":case"ArrowLeft":case"a":case"A":this.player.tryMove(-1,0);break;case"Right":case"ArrowRight":case"d":case"D":this.player.tryMove(1,0);break;case" ":this.player.tryMove(0,0);break;case"Enter":case"Return":this.player.activateTile()}this.tick()}}draw(){if(this.FSM.currentState.name==N){const t=(new Date).getTime();t>=this.lastAnimateUpdate+rt&&(this.lastAnimateUpdate=t,this.renderer.updateScreen(this.mapper.getCurrentLevel()),this.sidebarNeedsUpdate&&(this.sidebarNeedsUpdate=!1,this.renderer.updateSidebar(this.level,this.score,null))),requestAnimationFrame(this.draw.bind(this))}}tick(){const t=this.mapper.getCurrentLevel();if(t){const e=t.getMonsters();for(let i=e.length-1;i>=0;i--)e[i].isDead()?t.removeActor(e[i]):e[i].tickUpdate();this.player.tickUpdate(),this.player.isDead()&&(this.AddScoreAndGetList(this.score,!1),this.sidebarNeedsUpdate=!0,this.FSM.triggerEvent(C)),this.spawnCounter--,this.spawnCounter<=0&&(t.spawnMonster(),this.spawnCounter=this.spawnRate,this.spawnRate--)}}showTitle(){this.renderer.showTitle(this.getScores())}showGameWin(){const t=this.AddScoreAndGetList(this.score,!0);this.renderer.showGameWin(t)}showGameLose(){const t=this.AddScoreAndGetList(this.score,!0);this.renderer.showGameLose(t)}startGame(){this.renderer.hideOverlays(),this.level=1,this.score=0,this.numSpells=1,this.spawnCounter=0,this.spawnRate=15,this.sidebarNeedsUpdate=!0,this.player=new xt(null),this.player.offsetX=0,this.player.offsetY=0,this.player.stunned=!1,this.player.lastMove=[0,0],this.mapper.reset();this.mapper.getOrCreateLevel(this.level)?(this.moveToLevel(this.level),this.tick(),this.draw()):console.error("Failed to create first level")}moveToLevel(t,e=!1){this.spawnRate=15,this.spawnCounter=this.spawnRate;const i=this.mapper.getOrCreateLevel(t),r=this.mapper.getCurrentLevel();r&&this.player&&this.player.tile&&r.removeActor(this.player),i.addActor(this.player,e),this.sidebarNeedsUpdate=!0}AddScoreAndGetList(t,e){const i=this.getScores(),r=new ct(t,1,t,e),s=i.pop();return s&&(s.active?(r.run=s.run+1,r.totalScore+=s.totalScore):i.push(s)),i.push(r),this.localStorage.scores=JSON.stringify(i),i}getScores(){return this.localStorage.scores?JSON.parse(this.localStorage.scores):[]}prevLevel(){if(this.level>1){if(!this.mapper.getOrCreateLevel(this.level-1))return void console.error("Failed to create previous level");this.level--,this.moveToLevel(this.level,!0)}}nextLevel(){10==this.level?this.FSM.triggerEvent(I):(this.audioPlayer.playSound(B.NEWLEVEL),this.level++,this.moveToLevel(this.level))}};Lt=Tt([E(),_t(0,k("IAudioPlayer")),_t(1,k("IMapper")),_t(2,k("IRenderer")),Mt("design:paramtypes",[Object,Object,Object])],Lt);class Rt extends gt{constructor(t,e,i){super(t,e,i,dt.FountainActive,!0),this.stepEffectActive=!0}stepOn(t){console.log(t)}activate(t){this.stepEffectActive&&t&&t.isPlayer&&(this.stepEffectActive=!1,this.sprite=dt.FountainInactive,t.heal(10))}}class kt extends gt{constructor(t,e,i){super(t,e,i,dt.SpikePit,!0)}stepOn(t){t&&(t.hit(1),t.isPlayer&&tt.getInstance().publish(Q,5))}activate(t){console.log(t)}}class At extends gt{constructor(t,e,i){super(t,e,i,dt.Wall,!1)}stepOn(t){throw console.log(t),new Error("Shouldn't be able to step on a wall tile")}activate(t){throw console.log(t),new Error("Shouldn't be able to activate a wall tile")}}class Et{constructor(t,e,i,r){this.x=0,this.y=0,this.width=0,this.height=0,this.maxX=0,this.maxY=0,this.centerX=0,this.centerY=0,this.x=t||0,this.y=e||0,this.width=i||0,this.height=r||0,this.maxX=this.x+this.width,this.maxY=this.y+this.height,this.centerX=this.width>0?Math.ceil(this.x+this.width/2):0,this.centerY=this.height>0?Math.ceil(this.y+this.height/2):0}isZero(){return 0===this.x&&0===this.y&&0===this.width&&0===this.height}}class Pt{constructor(t,e,i,r){this.x=t,this.y=e,this.leafWidth=i,this.leafHeight=r,this.childLeafLeft=null,this.childLeafRight=null,this.room=new Et(0,0,0,0),this.room1=new Et(0,0,0,0),this.room2=new Et(0,0,0,0)}createRooms(t,e,i,r){if(null!==this.childLeafLeft||null!==this.childLeafRight)this.childLeafLeft&&this.childLeafLeft.createRooms(t,e,i,r),this.childLeafRight&&this.childLeafRight.createRooms(t,e,i,r),this.childLeafLeft&&this.childLeafRight&&t.createHall(this.childLeafLeft.getRoom(),this.childLeafRight.getRoom());else{const e=this.getRandomIntBetweenMinAndMax(r,Math.min(i,this.leafWidth-1)),s=this.getRandomIntBetweenMinAndMax(r,Math.min(i,this.leafHeight-1)),n=this.getRandomIntBetweenMinAndMax(this.x,this.x+(this.leafWidth-1)-e),o=this.getRandomIntBetweenMinAndMax(this.y,this.y+(this.leafHeight-1)-s);this.room=new Et(n,o,e,s),t.placeRoom(this.room)}}getRandomIntBetweenMinAndMax(t,e){return Math.floor(Math.random()*(e-t+1)+t)}splitLeaf(t){if(null!==this.childLeafLeft||null!==this.childLeafRight)return!1;let e=Math.random()>=.5;const i=this.leafWidth/this.leafHeight,r=this.leafHeight/this.leafWidth;i>=1.25?e=!1:r>=1.25&&(e=!0);const s=e?this.leafHeight-t:this.leafWidth-t;if(s<=t)return!1;const n=this.getRandomIntBetweenMinAndMax(t,s);return e?(this.childLeafLeft=new Pt(this.x,this.y,this.leafWidth,n),this.childLeafRight=new Pt(this.x,this.y+n,this.leafWidth,this.leafHeight-n)):(this.childLeafLeft=new Pt(this.x,this.y,n,this.leafHeight),this.childLeafRight=new Pt(this.x+n,this.y,this.leafWidth-n,this.leafHeight)),!0}getRoom(){if(!this.room.isZero())return this.room;if(this.childLeafLeft&&(this.room1=this.childLeafLeft.getRoom()),this.childLeafRight&&(this.room2=this.childLeafRight.getRoom()),this.childLeafLeft||this.childLeafRight){if(this.room2.isZero())return this.room1;if(this.room1.isZero())return this.room2;return Math.random()>=.5?this.room1:this.room2}return new Et(0,0,0,0)}}class Ot extends St{constructor(t){super(t,ft.Bird,3)}}class Ct extends St{constructor(t){super(t,ft.Snake,1)}act(){this.attackedThisTurn=!1,super.act(),this.attackedThisTurn||super.act()}}class It extends St{constructor(t){super(t,ft.Tank,2)}tickUpdate(){const t=this.stunned;super.tickUpdate(),t||(this.stunned=!0)}}class jt extends St{constructor(t){super(t,ft.Eater,1)}act(){if(null===this.tile)return;const t=this.tile.getAdjacentNeighbors().filter((t=>t&&!t.passable));if(t.length){const e=bt(t)[0];e&&(e.map.replaceTile(e.x,e.y,new mt(e.map,e.x,e.y)),this.heal(.5))}else super.act()}}class Dt extends St{constructor(t){super(t,ft.Jester,2)}act(){if(null===this.tile)return;const t=this.tile.getAdjacentPassableNeighbors();if(t.length){const e=bt(t)[0];this.tryMove(e.x-this.tile.x,e.y-this.tile.y)}}}class Ft extends St{constructor(t){super(t,ft.Turret,1),this.directions=[z,V,K,$],this.currentDirection=wt(0,3)}act(){if(null===this.tile)return;this.currentDirection+=1,4==this.currentDirection&&(this.currentDirection=0);const t=this.directions[this.currentDirection];this.sprite=ft["Turret_"+t];const e=this.tile.getNeighborChain(t);e.some((t=>t.monster&&t.monster.isPlayer))&&e.forEach((e=>{switch(e.monster&&e.monster.hit(1),t){case z:case K:e.setEffect(ut.Bolt_Vertical);break;case V:case $:e.setEffect(ut.Bolt_Horizontal);break;default:throw"CardinalDirection didn't have a valid value."}}))}}class Nt extends gt{constructor(t,e,i){super(t,e,i,dt.StairUp,!0)}stepOn(t){console.log(t)}activate(t){t&&t.isPlayer&&this.map.prevLevel()}}class Wt extends gt{constructor(t,e,i){super(t,e,i,dt.StairDown,!0)}stepOn(t){console.log(t)}activate(t){t&&t.isPlayer&&this.map.nextLevel()}}class Bt{constructor(t,e){this.height=0,this.width=0,this.branch=G,this.stairsUp=null,this.stairsDown=null,this.width=t,this.height=e,this.monsters=new Array,this.tiles=new Array}getStairUpTile(){return this.stairsUp}getStairDownTile(){return this.stairsDown}setStairDownTile(){const t=this.randomPassableTile();return t&&(this.stairsDown=new Wt(this,t.x,t.y),this.replaceTile(t.x,t.y,this.stairsDown)),this.getStairDownTile()}setStairUpTile(){const t=this.randomPassableTile();return t&&(this.stairsUp=new Nt(this,t.x,t.y),this.replaceTile(t.x,t.y,this.stairsUp)),this.getStairUpTile()}removeActor(t){this.monsters=this.monsters.filter((e=>e!==t))}addActor(t,e=!1){this.monsters.push(t);let i=e?this.stairsDown:this.stairsUp;null===i&&(console.log("no stairs, placing on random tile"),i=this.randomPassableTile()),null!==i&&(console.log("placing actor on tile",i),t.setTile(i,!0))}getMonsters(){return this.monsters}getPlayer(){return this.monsters.find((t=>t.isPlayer))||null}getTile(t,e){try{if(this.inBounds(t,e))return this.tiles[t][e]}catch(i){console.log(i,t,e)}return null}nextLevel(){tt.getInstance().publish(q,null)}prevLevel(){tt.getInstance().publish(J,null)}randomPassableTile(){const t=this;let e=null;return function(t,e){for(let t=1e3;t>0;t--)if(e())return;throw"Timeout while trying to "+t}("get random passable tile",(function(){const i=wt(0,t.width-1),r=wt(0,t.height-1);return e=t.getTile(i,r),e&&e.passable&&!e.monster})),e}replaceTile(t,e,i){if(!this.inBounds(t,e))throw"attempting to replace a tile at non-existant location";this.tiles[t][e]=i}spawnMonster(){const t=new(0,bt([Ot,Ct,It,jt,Dt,Ft])[0])(this.randomPassableTile());this.monsters.push(t)}inBounds(t,e){return t>=0&&e>=0&&t<this.width&&e<this.height}}class Ht{constructor(t){this.levelIdx=t;const e=Math.floor(it+8*(t-1));this.map=new Bt(e,e)}generateLevel(t,e){this.levelIdx=t;const i=Math.floor(it+8*(t-1));return this.map=new Bt(i,i),this.generateTiles(),this.populateMap(),this.map}generateTiles(){for(let t=0;t<this.map.width;t++){this.map.tiles[t]=[];for(let e=0;e<this.map.height;e++)if(0==t||0==e||t==this.map.width-1||e==this.map.height-1)this.map.tiles[t][e]=new At(this.map,t,e);else{const i=Math.random();this.map.tiles[t][e]=i<.005?new Rt(this.map,t,e):i<.02?new kt(this.map,t,e):i<.3?new At(this.map,t,e):new mt(this.map,t,e)}}}populateMap(){this.generateMonsters(),this.placeBooks(),this.levelIdx>1&&(console.log("Placing stairs up"),this.placeStairsUp()),this.placeStairsDown(),console.log("Level "+this.levelIdx+" generated"),this.overrideWallSpritesOnEdges()}generateMonsters(){const t=Math.ceil((this.levelIdx+1)/2)+1;for(let e=0;e<t;e++)this.map.monsters.push(this.spawnMonster())}spawnMonster(){return new(0,bt([Ot,Ct,It,jt,Dt,Ft])[0])(this.map.randomPassableTile())}placeBooks(){let t=0;for(;t<3;){const e=this.map.randomPassableTile();e&&e instanceof mt&&(t++,e.book=!0)}}placeStairsDown(){this.map.setStairDownTile()}placeStairsUp(){this.map.setStairUpTile()}overrideWallSpritesOnEdges(){for(let t=0;t<this.map.height;t++)for(let e=0;e<this.map.width;e++){const i=this.map.getTile(e,t);if(i instanceof At){const t=i.getAdjacentNeighbors();if(t&&t.length>0){const e=this.getSpriteVariationSuffixForTile(t,At);e&&(i.sprite=dt["Wall_"+e])}}}}getSpriteVariationSuffixForTile(t,e){let i="";return t[2]&&t[2]instanceof e&&(i+="L"),t[3]&&t[3]instanceof e&&(i+="R"),t[0]&&t[0]instanceof e&&(i+="T"),t[1]&&t[1]instanceof e&&(i+="B"),i}}class Ut extends Ht{constructor(t){super(t),this.maxLeafSize=12,this.minLeafSize=3,this.roomMaxSize=10,this.roomMinSize=3,this.leaves=[],this.maxLeafSize=this.maxLeafSize,this.generate()}generate(){this.generateTiles(),super.populateMap()}generateTiles(){this.initialiseMap();const t=new Pt(0,0,this.map.width,this.map.height);this.leaves.push(t);let e=!0;for(;e;){e=!1;for(let t=0;t<this.leaves.length;t++){const i=this.leaves[t];i&&(i.childLeafLeft||i.childLeafRight||!(i.leafWidth>this.maxLeafSize||i.leafHeight>this.maxLeafSize)||i.splitLeaf(this.minLeafSize)&&(i.childLeafLeft&&this.leaves.push(i.childLeafLeft),i.childLeafRight&&this.leaves.push(i.childLeafRight),e=!0))}}t.createRooms(this,this.maxLeafSize,this.roomMaxSize,this.roomMinSize)}initialiseMap(){for(let t=0;t<this.map.width;t++){this.map.tiles[t]=[];for(let e=0;e<this.map.height;e++)this.map.tiles[t][e]=new At(this.map,t,e)}}placeRoom(t){for(let e=t.x+1;e<t.maxX;e++)for(let i=t.y+1;i<t.maxY;i++){const t=Math.random();this.map.tiles[e][i]=t<.005?new Rt(this.map,e,i):t<.02?new kt(this.map,e,i):new mt(this.map,e,i)}}createHall(t,e){Math.random()>=.5?(this.makeHorizontalTunnel(t.centerX,e.centerX,t.centerY),this.makeVerticalTunnel(t.centerY,e.centerY,e.centerX)):(this.makeVerticalTunnel(t.centerY,e.centerY,t.centerX),this.makeHorizontalTunnel(t.centerX,e.centerX,e.centerY))}makeHorizontalTunnel(t,e,i){const r=Math.min(t,e),s=Math.max(t,e);for(let t=r;t<=s;t++)this.map.tiles[t][i]=new mt(this.map,t,i)}makeVerticalTunnel(t,e,i){for(let r=Math.min(t,e);r<=Math.max(t,e);r++)this.map.tiles[i][r]=new mt(this.map,i,r)}}class Yt{generateLevel(t,e){if(e===G)return this.generateLibraryLevel(t);throw"branch not supported"}generateLibraryLevel(t){return new Ut(t).map}}var Xt=function(t,e,i,r){var s,n=arguments.length,o=n<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,i,r);else for(var a=t.length-1;a>=0;a--)(s=t[a])&&(o=(n<3?s(o):n>3?s(e,i,o):s(e,i))||o);return n>3&&o&&Object.defineProperty(e,i,o),o},Gt=function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},zt=function(t,e){return function(i,r){e(i,r,t)}};let Vt=class{constructor(t){this.levelGenerator=t,this.currentFloorIdx=0,this.floors=new Array}getOrCreateLevel(t){let e=this.floors[t];return void 0!==e?(this.currentFloorIdx=t,e):(e=this.levelGenerator.generateLevel(t,G),this.currentFloorIdx=t,this.floors[t]=e,e)}getCurrentLevel(){return void 0===this.floors[this.currentFloorIdx]?this.getOrCreateLevel(this.currentFloorIdx):this.floors[this.currentFloorIdx]}reset(){this.floors=new Array}};Vt=Xt([E(),zt(0,k("ILevelGenerator")),Gt("design:paramtypes",[Object])],Vt);class Kt{constructor(){this.amount=0,this.x=0,this.y=0}}var $t=function(t,e,i,r){var s,n=arguments.length,o=n<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,i,r);else for(var a=t.length-1;a>=0;a--)(s=t[a])&&(o=(n<3?s(o):n>3?s(e,i,o):s(e,i))||o);return n>3&&o&&Object.defineProperty(e,i,o),o},qt=function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)};let Jt=class{constructor(){this.showAlternateSprites=!1,this.viewportWidth=it,this.viewportHeight=it,this.viewportX=0,this.viewportY=0,this.map=null,this.lastAlternateSpriteTimeMS=Date.now(),this.monsterSpriteSheet=new Image,this.tileSpriteSheet=new Image,this.effectSpriteSheet=new Image,this.itemSpriteSheet=new Image,this.onLoadCompletedCallback=null;const t=document.getElementById("playerLocation");if(!t)throw"can't load pleyer location elem";this.playerLocationElem=t;const e=document.getElementById("playerBooks");if(!e)throw"can't load Player Books elem";this.playerBooksElem=e,this.shake=new Kt;const i=document.querySelector("canvas");if(!i)throw"Canvas can't load";{this.canvas=i;const t=this.canvas.getContext("2d");if(!t)throw"Ctx can't load";this.ctx=t}this.setupCanvas(),tt.getInstance().subscribe(Q,this.setShakeAmount.bind(this))}initSpriteSheet(t){this.onLoadCompletedCallback=t,this.monsterSpriteSheet.onload=this.checkAllSpriteSheetsLoaded.bind(this),this.tileSpriteSheet.onload=this.checkAllSpriteSheetsLoaded.bind(this),this.effectSpriteSheet.onload=this.checkAllSpriteSheetsLoaded.bind(this),this.itemSpriteSheet.onload=this.checkAllSpriteSheetsLoaded.bind(this),this.monsterSpriteSheet.src=et+"monsters1.png",this.tileSpriteSheet.src=et+"library_new.png",this.effectSpriteSheet.src=et+"effects.png",this.itemSpriteSheet.src=et+"items.png"}checkAllSpriteSheetsLoaded(){this.monsterSpriteSheet.complete&&this.tileSpriteSheet.complete&&this.effectSpriteSheet.complete&&this.itemSpriteSheet.complete&&null!==this.onLoadCompletedCallback&&this.onLoadCompletedCallback()}setupCanvas(){this.canvas&&this.ctx&&(this.canvas.width=st*this.viewportWidth,this.canvas.height=st*this.viewportHeight,this.canvas.style.width=this.canvas.width+"px",this.canvas.style.height=this.canvas.height+"px",this.ctx.imageSmoothingEnabled=!1,this.ctx.font="consolas, monospace")}getSpriteSheet(t){switch(t){case Y:return this.monsterSpriteSheet;case X:return this.tileSpriteSheet;case H:return this.effectSpriteSheet;case U:return this.itemSpriteSheet;default:throw"Sprite sheet does not exist!"}}updateViewportPosition(t){if(!t.tile||!this.map)return;const e=t.tile.x-Math.floor(this.viewportWidth/2),i=t.tile.y-Math.floor(this.viewportHeight/2),r=this.map.width-this.viewportWidth,s=this.map.height-this.viewportHeight,n=this.viewportX+Math.floor(this.viewportWidth/2),o=this.viewportY+Math.floor(this.viewportHeight/2),a=t.tile.x-n,l=t.tile.y-o;Math.abs(a)>3&&(this.viewportX=Math.max(0,Math.min(r,e))),Math.abs(l)>3&&(this.viewportY=Math.max(0,Math.min(s,i)))}drawMinimap(){if(!this.map)return;const t=10,e=Math.max(2,Math.floor(150/Math.max(this.map.width,this.map.height))),i=this.map.width*e,r=this.map.height*e,s=this.canvas.width-i-t,n=t;this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(s-t,0,i+20,r+20);const o=this.map.getStairUpTile(),a=this.map.getStairDownTile();console.log("Stairs Up:",null==o?void 0:o.x,null==o?void 0:o.y),console.log("Stairs Down:",null==a?void 0:a.x,null==a?void 0:a.y);let l=0,h=0,c=0;for(let t=0;t<this.map.width;t++)for(let i=0;i<this.map.height;i++){const r=this.map.getTile(t,i);if(r&&r.seen){l++;let u=r.visible?.9:.5;r.passable?r.sprite===dt.SpikePit?this.ctx.fillStyle=`rgba(255, 50, 50, ${u})`:r.sprite===dt.FountainActive?this.ctx.fillStyle=`rgba(50, 150, 255, ${u})`:r.sprite===dt.FountainInactive?this.ctx.fillStyle=`rgba(100, 100, 255, ${u})`:r===o||r===a?(c++,this.ctx.fillStyle=r===o?`rgba(0, 255, 255, ${u})`:`rgba(255, 0, 255, ${u})`):r.book?this.ctx.fillStyle=`rgba(255, 215, 0, ${u})`:this.ctx.fillStyle=`rgba(80, 80, 80, ${u})`:(h++,this.ctx.fillStyle=`rgba(200, 200, 200, ${u})`),this.ctx.fillRect(s+t*e,n+i*e,e,e)}}console.log(`Minimap stats - Seen: ${l}, Walls: ${h}, Stairs: ${c}`),this.ctx.fillStyle="rgba(255, 0, 0, 0.9)";const u=this.map.getMonsters();for(const t of u)t.tile&&t.tile.visible&&this.ctx.fillRect(s+t.tile.x*e,n+t.tile.y*e,e,e);const p=this.map.getPlayer();p&&p.tile&&(this.ctx.fillStyle="rgba(255, 255, 255, 1.0)",this.ctx.fillRect(s+p.tile.x*e,n+p.tile.y*e,e,e)),this.ctx.strokeStyle="rgba(255, 255, 255, 0.8)",this.ctx.lineWidth=1,this.ctx.strokeRect(s+this.viewportX*e,n+this.viewportY*e,this.viewportWidth*e,this.viewportHeight*e)}updateVisibility(){if(!this.map)return;for(let t=0;t<this.map.width;t++)for(let e=0;e<this.map.height;e++){const i=this.map.getTile(t,e);i&&(i.visible=!1)}const t=this.map.getPlayer();if(!t||!t.tile)return;const e=t.tile.x,i=t.tile.y;for(let t=Math.max(0,e-8);t<Math.min(this.map.width,e+8+1);t++)for(let r=Math.max(0,i-8);r<Math.min(this.map.height,i+8+1);r++){const s=t-e,n=r-i;if(s*s+n*n>64)continue;const o=this.map.getTile(t,r);if(!o)continue;let a=!0;const l=Math.max(Math.abs(s),Math.abs(n));if(0===l)a=!0;else{const t=s/l,r=n/l;for(let s=1;s<l;s++){const n=Math.round(e+t*s),o=Math.round(i+r*s),l=this.map.getTile(n,o);if(l&&!l.passable){a=!1;break}}}a&&(o.visible=!0,o.seen=!0)}}updateScreen(t){this.clearCanvas(),this.screenshake(),this.map=t;const e=Date.now();e-this.lastAlternateSpriteTimeMS>600&&(this.showAlternateSprites=!this.showAlternateSprites,this.lastAlternateSpriteTimeMS=e);const i=[],r=t.getPlayer();r&&r.tile&&(this.updateViewportPosition(r),this.updateVisibility());for(let e=this.viewportX;e<Math.min(this.viewportX+this.viewportWidth,t.width);e++)for(let r=this.viewportY;r<Math.min(this.viewportY+this.viewportHeight,t.height);r++){const s=t.getTile(e,r);s&&(this.drawTile(s),s.monster&&i.push(s.monster))}for(let t=0;t<i.length;t++){const e=i[t];if(!e.tile)continue;const r=e.tile.x,s=e.tile.y;r>=this.viewportX&&r<this.viewportX+this.viewportWidth&&s>=this.viewportY&&s<this.viewportY+this.viewportHeight&&this.drawMonster(e)}this.drawMinimap()}drawTile(t){if(!t)throw"tile cannot be null";const e=t.x-this.viewportX,i=t.y-this.viewportY;this.drawSprite(X,t.sprite,e,i),t.book&&this.drawSprite(U,pt,e,i),t.effectCounter>0&&(t.effectCounter--,this.drawSprite(H,t.effectIndex,e,i,t.effectCounter))}drawMonster(t){if(!t)throw"Monster cannot be null";const e=t.getDisplayX()-this.viewportX,i=t.getDisplayY()-this.viewportY;if(t.teleportCounter>0)this.drawSprite(Y,ft.MonsterLoad,e,i);else{this.drawSprite(Y,t.sprite,e,i);for(let r=0;r<t.hp;r++)this.drawSprite(Y,ft.HP,e+r%3*(5/16),i-Math.floor(r/3)*(5/16))}t.offsetX-=Math.sign(t.offsetX)*(1/8),t.offsetY-=Math.sign(t.offsetY)*(1/8)}drawSprite(t,e,i,r,s=0){if(t===H&&s&&s>0&&(this.ctx.globalAlpha=s/rt),e){const n=e[0];let o=e[1];t===Y&&this.showAlternateSprites&&(o=1),this.ctx.drawImage(this.getSpriteSheet(t),16*n,16*o,16,16,i*st+this.shake.x,r*st+this.shake.y,st,st),t===H&&(!s||s<=0)&&(this.ctx.globalAlpha=1)}}clearCanvas(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}screenshake(){this.shake.amount&&this.shake.amount--;const t=Math.random()*Math.PI*2;this.shake.x=Math.round(Math.cos(t)*this.shake.amount),this.shake.y=Math.round(Math.sin(t)*this.shake.amount)}hideOverlays(){const t=document.getElementsByClassName("overlay");if(t)for(let e=0;e<t.length;e++)if(t[e]){t[e].style.display="none"}}showTitle(t){const e=document.getElementById("TitleOverlay");e&&(t&&t.length>0&&this.drawScores(t),e.style.display="block")}showGameWin(t){const e=document.getElementById("GameWinOverlay");e&&(t&&t.length>0&&this.drawScores(t),e.style.display="block")}showGameLose(t){const e=document.getElementById("GameLoseOverlay");e&&(t&&t.length>0&&this.drawScores(t),e.style.display="block")}updateSidebar(t,e,i){this.playerBooksElem.innerText=e.toString(),this.playerLocationElem.innerText=t.toString();const r=document.getElementById("spells");if(r){for(;r.hasChildNodes();)r.firstChild&&r.removeChild(r.firstChild);const t=document.createDocumentFragment();if(null!=i)for(let e=0;e<Object.keys(i).length;e++){const r=document.createElement("button");r.className="spellButton",r.innerText="("+(e+1)+") "+(i[e].name||""),t.append(r)}r.appendChild(t)}}drawScores(t){const e=t.pop();void 0!==e&&(t.sort((function(t,e){return e.totalScore-t.totalScore})),t.unshift(e));const i=document.getElementsByClassName("scores");for(let e=0;e<i.length;e++){const r=i[e].children[1];if(r)for(;r.hasChildNodes();)r.firstChild&&r.removeChild(r.firstChild);const s=new DocumentFragment;for(let e=0;e<Math.min(10,t.length);e++){const i=document.createElement("tr"),r=document.createElement("td"),n=document.createElement("td"),o=document.createElement("td");r.innerHTML=t[e].run.toString(),n.innerHTML=t[e].score.toString(),o.innerHTML=t[e].totalScore.toString(),i.appendChild(r),i.appendChild(n),i.appendChild(o),s.appendChild(i)}r.appendChild(s)}}setShakeAmount(t){this.shake.amount=t}};Jt=$t([E(),qt("design:paramtypes",[])],Jt);var Zt=function(t,e,i,r){var s,n=arguments.length,o=n<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,i,r);else for(var a=t.length-1;a>=0;a--)(s=t[a])&&(o=(n<3?s(o):n>3?s(e,i,o):s(e,i))||o);return n>3&&o&&Object.defineProperty(e,i,o),o},Qt=function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)};let te=class{constructor(){R.register("IAudioPlayer",{useClass:at}),R.register("ILevelGenerator",{useClass:Yt}),R.register("IMapper",{useClass:Vt}),R.register("IRenderer",{useClass:Jt}),this.game=R.resolve(Lt)}init(){this.game.init()}};te=Zt([A(),Qt("design:paramtypes",[])],te);var ee=te;export{ee as default};
