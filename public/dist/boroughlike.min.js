var t,e;!function(t){!function(e){var r="object"==typeof global?global:"object"==typeof self?self:"object"==typeof this?this:Function("return this;")(),i=s(t);function s(t,e){return function(r,i){"function"!=typeof t[r]&&Object.defineProperty(t,r,{configurable:!0,writable:!0,value:i}),e&&e(r,i)}}void 0===r.Reflect?r.Reflect=t:i=s(r.Reflect,i),function(t){var e=Object.prototype.hasOwnProperty,r="function"==typeof Symbol,i=r&&void 0!==Symbol.toPrimitive?Symbol.toPrimitive:"@@toPrimitive",s=r&&void 0!==Symbol.iterator?Symbol.iterator:"@@iterator",n="function"==typeof Object.create,o={__proto__:[]}instanceof Array,a=!n&&!o,l={create:n?function(){return it(Object.create(null))}:o?function(){return it({__proto__:null})}:function(){return it({})},has:a?function(t,r){return e.call(t,r)}:function(t,e){return e in t},get:a?function(t,r){return e.call(t,r)?t[r]:void 0}:function(t,e){return t[e]}},h=Object.getPrototypeOf(Function),c="object"==typeof process&&process.env&&"true"===process.env.REFLECT_METADATA_USE_MAP_POLYFILL,u=c||"function"!=typeof Map||"function"!=typeof Map.prototype.entries?tt():Map,p=c||"function"!=typeof Set||"function"!=typeof Set.prototype.entries?et():Set,f=new(c||"function"!=typeof WeakMap?rt():WeakMap);function d(t,e,r,i){if(j(r)){if(!X(t))throw new TypeError;if(!z(e))throw new TypeError;return _(t,e)}if(!X(t))throw new TypeError;if(!F(e))throw new TypeError;if(!F(i)&&!j(i)&&!D(i))throw new TypeError;return D(i)&&(i=void 0),L(t,e,r=Y(r),i)}function y(t,e){function r(r,i){if(!F(r))throw new TypeError;if(!j(i)&&!V(i))throw new TypeError;P(t,e,r,i)}return r}function g(t,e,r,i){if(!F(r))throw new TypeError;return j(i)||(i=Y(i)),P(t,e,r,i)}function v(t,e,r){if(!F(e))throw new TypeError;return j(r)||(r=Y(r)),M(t,e,r)}function m(t,e,r){if(!F(e))throw new TypeError;return j(r)||(r=Y(r)),k(t,e,r)}function w(t,e,r){if(!F(e))throw new TypeError;return j(r)||(r=Y(r)),A(t,e,r)}function b(t,e,r){if(!F(e))throw new TypeError;return j(r)||(r=Y(r)),E(t,e,r)}function S(t,e){if(!F(t))throw new TypeError;return j(e)||(e=Y(e)),O(t,e)}function x(t,e){if(!F(t))throw new TypeError;return j(e)||(e=Y(e)),C(t,e)}function T(t,e,r){if(!F(e))throw new TypeError;j(r)||(r=Y(r));var i=R(e,r,!1);if(j(i))return!1;if(!i.delete(t))return!1;if(i.size>0)return!0;var s=f.get(e);return s.delete(r),s.size>0||f.delete(e),!0}function _(t,e){for(var r=t.length-1;r>=0;--r){var i=(0,t[r])(e);if(!j(i)&&!D(i)){if(!z(i))throw new TypeError;e=i}}return e}function L(t,e,r,i){for(var s=t.length-1;s>=0;--s){var n=(0,t[s])(e,r,i);if(!j(n)&&!D(n)){if(!F(n))throw new TypeError;i=n}}return i}function R(t,e,r){var i=f.get(t);if(j(i)){if(!r)return;i=new u,f.set(t,i)}var s=i.get(e);if(j(s)){if(!r)return;s=new u,i.set(e,s)}return s}function M(t,e,r){if(k(t,e,r))return!0;var i=$(e);return!D(i)&&M(t,i,r)}function k(t,e,r){var i=R(e,r,!1);return!j(i)&&H(i.has(t))}function A(t,e,r){if(k(t,e,r))return E(t,e,r);var i=$(e);return D(i)?void 0:A(t,i,r)}function E(t,e,r){var i=R(e,r,!1);if(!j(i))return i.get(t)}function P(t,e,r,i){R(r,i,!0).set(t,e)}function O(t,e){var r=C(t,e),i=$(t);if(null===i)return r;var s=O(i,e);if(s.length<=0)return r;if(r.length<=0)return s;for(var n=new p,o=[],a=0,l=r;a<l.length;a++){var h=l[a];n.has(h)||(n.add(h),o.push(h))}for(var c=0,u=s;c<u.length;c++){h=u[c];n.has(h)||(n.add(h),o.push(h))}return o}function C(t,e){var r=[],i=R(t,e,!1);if(j(i))return r;for(var s=q(i.keys()),n=0;;){var o=Z(s);if(!o)return r.length=n,r;var a=J(o);try{r[n]=a}catch(t){try{Q(s)}finally{throw t}}n++}}function I(t){if(null===t)return 1;switch(typeof t){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return null===t?1:6;default:return 6}}function j(t){return void 0===t}function D(t){return null===t}function N(t){return"symbol"==typeof t}function F(t){return"object"==typeof t?null!==t:"function"==typeof t}function W(t,e){switch(I(t)){case 0:case 1:case 2:case 3:case 4:case 5:return t}var r=3===e?"string":5===e?"number":"default",s=K(t,i);if(void 0!==s){var n=s.call(t,r);if(F(n))throw new TypeError;return n}return B(t,"default"===r?"number":r)}function B(t,e){if("string"===e){var r=t.toString;if(G(r))if(!F(s=r.call(t)))return s;if(G(i=t.valueOf))if(!F(s=i.call(t)))return s}else{var i;if(G(i=t.valueOf))if(!F(s=i.call(t)))return s;var s,n=t.toString;if(G(n))if(!F(s=n.call(t)))return s}throw new TypeError}function H(t){return!!t}function U(t){return""+t}function Y(t){var e=W(t,3);return N(e)?e:U(e)}function X(t){return Array.isArray?Array.isArray(t):t instanceof Object?t instanceof Array:"[object Array]"===Object.prototype.toString.call(t)}function G(t){return"function"==typeof t}function z(t){return"function"==typeof t}function V(t){switch(I(t)){case 3:case 4:return!0;default:return!1}}function K(t,e){var r=t[e];if(null!=r){if(!G(r))throw new TypeError;return r}}function q(t){var e=K(t,s);if(!G(e))throw new TypeError;var r=e.call(t);if(!F(r))throw new TypeError;return r}function J(t){return t.value}function Z(t){var e=t.next();return!e.done&&e}function Q(t){var e=t.return;e&&e.call(t)}function $(t){var e=Object.getPrototypeOf(t);if("function"!=typeof t||t===h)return e;if(e!==h)return e;var r=t.prototype,i=r&&Object.getPrototypeOf(r);if(null==i||i===Object.prototype)return e;var s=i.constructor;return"function"!=typeof s||s===t?e:s}function tt(){var t={},e=[],r=function(){function t(t,e,r){this._index=0,this._keys=t,this._values=e,this._selector=r}return t.prototype["@@iterator"]=function(){return this},t.prototype[s]=function(){return this},t.prototype.next=function(){var t=this._index;if(t>=0&&t<this._keys.length){var r=this._selector(this._keys[t],this._values[t]);return t+1>=this._keys.length?(this._index=-1,this._keys=e,this._values=e):this._index++,{value:r,done:!1}}return{value:void 0,done:!0}},t.prototype.throw=function(t){throw this._index>=0&&(this._index=-1,this._keys=e,this._values=e),t},t.prototype.return=function(t){return this._index>=0&&(this._index=-1,this._keys=e,this._values=e),{value:t,done:!0}},t}();return function(){function e(){this._keys=[],this._values=[],this._cacheKey=t,this._cacheIndex=-2}return Object.defineProperty(e.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),e.prototype.has=function(t){return this._find(t,!1)>=0},e.prototype.get=function(t){var e=this._find(t,!1);return e>=0?this._values[e]:void 0},e.prototype.set=function(t,e){var r=this._find(t,!0);return this._values[r]=e,this},e.prototype.delete=function(e){var r=this._find(e,!1);if(r>=0){for(var i=this._keys.length,s=r+1;s<i;s++)this._keys[s-1]=this._keys[s],this._values[s-1]=this._values[s];return this._keys.length--,this._values.length--,e===this._cacheKey&&(this._cacheKey=t,this._cacheIndex=-2),!0}return!1},e.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=t,this._cacheIndex=-2},e.prototype.keys=function(){return new r(this._keys,this._values,i)},e.prototype.values=function(){return new r(this._keys,this._values,n)},e.prototype.entries=function(){return new r(this._keys,this._values,o)},e.prototype["@@iterator"]=function(){return this.entries()},e.prototype[s]=function(){return this.entries()},e.prototype._find=function(t,e){return this._cacheKey!==t&&(this._cacheIndex=this._keys.indexOf(this._cacheKey=t)),this._cacheIndex<0&&e&&(this._cacheIndex=this._keys.length,this._keys.push(t),this._values.push(void 0)),this._cacheIndex},e}();function i(t,e){return t}function n(t,e){return e}function o(t,e){return[t,e]}}function et(){return function(){function t(){this._map=new u}return Object.defineProperty(t.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),t.prototype.has=function(t){return this._map.has(t)},t.prototype.add=function(t){return this._map.set(t,t),this},t.prototype.delete=function(t){return this._map.delete(t)},t.prototype.clear=function(){this._map.clear()},t.prototype.keys=function(){return this._map.keys()},t.prototype.values=function(){return this._map.values()},t.prototype.entries=function(){return this._map.entries()},t.prototype["@@iterator"]=function(){return this.keys()},t.prototype[s]=function(){return this.keys()},t}()}function rt(){var t=16,r=l.create(),i=s();return function(){function t(){this._key=s()}return t.prototype.has=function(t){var e=n(t,!1);return void 0!==e&&l.has(e,this._key)},t.prototype.get=function(t){var e=n(t,!1);return void 0!==e?l.get(e,this._key):void 0},t.prototype.set=function(t,e){return n(t,!0)[this._key]=e,this},t.prototype.delete=function(t){var e=n(t,!1);return void 0!==e&&delete e[this._key]},t.prototype.clear=function(){this._key=s()},t}();function s(){var t;do{t="@@WeakMap@@"+h()}while(l.has(r,t));return r[t]=!0,t}function n(t,r){if(!e.call(t,i)){if(!r)return;Object.defineProperty(t,i,{value:l.create()})}return t[i]}function o(t,e){for(var r=0;r<e;++r)t[r]=255*Math.random()|0;return t}function a(t){return"function"==typeof Uint8Array?"undefined"!=typeof crypto?crypto.getRandomValues(new Uint8Array(t)):"undefined"!=typeof msCrypto?msCrypto.getRandomValues(new Uint8Array(t)):o(new Uint8Array(t),t):o(new Array(t),t)}function h(){var e=a(t);e[6]=79&e[6]|64,e[8]=191&e[8]|128;for(var r="",i=0;i<t;++i){var s=e[i];4!==i&&6!==i&&8!==i||(r+="-"),s<16&&(r+="0"),r+=s.toString(16).toLowerCase()}return r}}function it(t){return t.__=void 0,delete t.__,t}t("decorate",d),t("metadata",y),t("defineMetadata",g),t("hasMetadata",v),t("hasOwnMetadata",m),t("getMetadata",w),t("getOwnMetadata",b),t("getMetadataKeys",S),t("getOwnMetadataKeys",x),t("deleteMetadata",T)}(i)}()}(t||(t={})),function(t){t[t.Transient=0]="Transient",t[t.Singleton=1]="Singleton",t[t.ResolutionScoped=2]="ResolutionScoped",t[t.ContainerScoped=3]="ContainerScoped"}(e||(e={}));var r=e,i=function(t,e){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])},i(t,e)};function s(t,e){function r(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}function n(t,e,r,i){return new(r||(r=Promise))((function(s,n){function o(t){try{l(i.next(t))}catch(t){n(t)}}function a(t){try{l(i.throw(t))}catch(t){n(t)}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(o,a)}l((i=i.apply(t,e||[])).next())}))}function o(t,e){var r,i,s,n,o={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return n={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function a(n){return function(a){return function(n){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,i&&(s=2&n[0]?i.return:n[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,n[1])).done)return s;switch(i=0,s&&(n=[2&n[0],s.value]),n[0]){case 0:case 1:s=n;break;case 4:return o.label++,{value:n[1],done:!1};case 5:o.label++,i=n[1],n=[0];continue;case 7:n=o.ops.pop(),o.trys.pop();continue;default:if(!(s=o.trys,(s=s.length>0&&s[s.length-1])||6!==n[0]&&2!==n[0])){o=0;continue}if(3===n[0]&&(!s||n[1]>s[0]&&n[1]<s[3])){o.label=n[1];break}if(6===n[0]&&o.label<s[1]){o.label=s[1],s=n;break}if(s&&o.label<s[2]){o.label=s[2],o.ops.push(n);break}s[2]&&o.ops.pop(),o.trys.pop();continue}n=e.call(t,o)}catch(t){n=[6,t],i=0}finally{r=s=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,a])}}}function a(t){var e="function"==typeof Symbol&&Symbol.iterator,r=e&&t[e],i=0;if(r)return r.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&i>=t.length&&(t=void 0),{value:t&&t[i++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function l(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var i,s,n=r.call(t),o=[];try{for(;(void 0===e||e-- >0)&&!(i=n.next()).done;)o.push(i.value)}catch(t){s={error:t}}finally{try{i&&!i.done&&(r=n.return)&&r.call(n)}finally{if(s)throw s.error}}return o}function h(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(l(arguments[e]));return t}var c="injectionTokens";function u(t){return!!t.useClass}function p(t){return!!t.useFactory}var f=function(){function t(t){this.wrap=t,this.reflectMethods=["get","getPrototypeOf","setPrototypeOf","getOwnPropertyDescriptor","defineProperty","has","set","deleteProperty","apply","construct","ownKeys"]}return t.prototype.createProxy=function(t){var e,r=this,i=!1;return new Proxy({},this.createHandler((function(){return i||(e=t(r.wrap()),i=!0),e})))},t.prototype.createHandler=function(t){var e={};return this.reflectMethods.forEach((function(r){e[r]=function(){for(var e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];return e[0]=t(),Reflect[r].apply(void 0,h(e))}})),e},t}();function d(t){return"string"==typeof t||"symbol"==typeof t}function y(t){return"object"==typeof t&&"token"in t&&"transform"in t}function g(t){return!!t.useToken}function v(t){return null!=t.useValue}var m=function(){function t(){this._registryMap=new Map}return t.prototype.entries=function(){return this._registryMap.entries()},t.prototype.getAll=function(t){return this.ensure(t),this._registryMap.get(t)},t.prototype.get=function(t){this.ensure(t);var e=this._registryMap.get(t);return e[e.length-1]||null},t.prototype.set=function(t,e){this.ensure(t),this._registryMap.get(t).push(e)},t.prototype.setAll=function(t,e){this._registryMap.set(t,e)},t.prototype.has=function(t){return this.ensure(t),this._registryMap.get(t).length>0},t.prototype.clear=function(){this._registryMap.clear()},t.prototype.ensure=function(t){this._registryMap.has(t)||this._registryMap.set(t,[])},t}(),w=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return s(e,t),e}(m),b=function(){this.scopedResolutions=new Map};function S(t,e,r){var i,s,n=l(t.toString().match(/constructor\(([\w, ]+)\)/)||[],2)[1],o=function(t,e){return null===t?"at position #"+e:'"'+t.split(",")[e].trim()+'" at position #'+e}(void 0===n?null:n,e);return i="Cannot inject the dependency "+o+' of "'+t.name+'" constructor. Reason:',void 0===s&&(s="    "),h([i],r.message.split("\n").map((function(t){return s+t}))).join("\n")}var x=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return s(e,t),e}(m),T=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return s(e,t),e}(m),_=function(){this.preResolution=new x,this.postResolution=new T},L=new Map,R=function(){function t(t){this.parent=t,this._registry=new w,this.interceptors=new _,this.disposed=!1,this.disposables=new Set}return t.prototype.register=function(t,e,i){var s;if(void 0===i&&(i={lifecycle:r.Transient}),this.ensureNotDisposed(),s=function(t){return u(t)||v(t)||g(t)||p(t)}(e)?e:{useClass:e},g(s))for(var n=[t],o=s;null!=o;){var a=o.useToken;if(n.includes(a))throw new Error("Token registration cycle detected! "+h(n,[a]).join(" -> "));n.push(a);var l=this._registry.get(a);o=l&&g(l.provider)?l.provider:null}if((i.lifecycle===r.Singleton||i.lifecycle==r.ContainerScoped||i.lifecycle==r.ResolutionScoped)&&(v(s)||p(s)))throw new Error('Cannot use lifecycle "'+r[i.lifecycle]+'" with ValueProviders or FactoryProviders');return this._registry.set(t,{provider:s,options:i}),this},t.prototype.registerType=function(t,e){return this.ensureNotDisposed(),d(e)?this.register(t,{useToken:e}):this.register(t,{useClass:e})},t.prototype.registerInstance=function(t,e){return this.ensureNotDisposed(),this.register(t,{useValue:e})},t.prototype.registerSingleton=function(t,e){if(this.ensureNotDisposed(),d(t)){if(d(e))return this.register(t,{useToken:e},{lifecycle:r.Singleton});if(e)return this.register(t,{useClass:e},{lifecycle:r.Singleton});throw new Error('Cannot register a type name as a singleton without a "to" token')}var i=t;return e&&!d(e)&&(i=e),this.register(t,{useClass:i},{lifecycle:r.Singleton})},t.prototype.resolve=function(t,e){void 0===e&&(e=new b),this.ensureNotDisposed();var r=this.getRegistration(t);if(!r&&d(t))throw new Error('Attempted to resolve unregistered dependency token: "'+t.toString()+'"');if(this.executePreResolutionInterceptor(t,"Single"),r){var i=this.resolveRegistration(r,e);return this.executePostResolutionInterceptor(t,i,"Single"),i}if(function(t){return"function"==typeof t||t instanceof f}(t)){i=this.construct(t,e);return this.executePostResolutionInterceptor(t,i,"Single"),i}throw new Error("Attempted to construct an undefined constructor. Could mean a circular dependency problem. Try using `delay` function.")},t.prototype.executePreResolutionInterceptor=function(t,e){var r,i;if(this.interceptors.preResolution.has(t)){var s=[];try{for(var n=a(this.interceptors.preResolution.getAll(t)),o=n.next();!o.done;o=n.next()){var l=o.value;"Once"!=l.options.frequency&&s.push(l),l.callback(t,e)}}catch(t){r={error:t}}finally{try{o&&!o.done&&(i=n.return)&&i.call(n)}finally{if(r)throw r.error}}this.interceptors.preResolution.setAll(t,s)}},t.prototype.executePostResolutionInterceptor=function(t,e,r){var i,s;if(this.interceptors.postResolution.has(t)){var n=[];try{for(var o=a(this.interceptors.postResolution.getAll(t)),l=o.next();!l.done;l=o.next()){var h=l.value;"Once"!=h.options.frequency&&n.push(h),h.callback(t,e,r)}}catch(t){i={error:t}}finally{try{l&&!l.done&&(s=o.return)&&s.call(o)}finally{if(i)throw i.error}}this.interceptors.postResolution.setAll(t,n)}},t.prototype.resolveRegistration=function(t,e){if(this.ensureNotDisposed(),t.options.lifecycle===r.ResolutionScoped&&e.scopedResolutions.has(t))return e.scopedResolutions.get(t);var i,s=t.options.lifecycle===r.Singleton,n=t.options.lifecycle===r.ContainerScoped,o=s||n;return i=v(t.provider)?t.provider.useValue:g(t.provider)?o?t.instance||(t.instance=this.resolve(t.provider.useToken,e)):this.resolve(t.provider.useToken,e):u(t.provider)?o?t.instance||(t.instance=this.construct(t.provider.useClass,e)):this.construct(t.provider.useClass,e):p(t.provider)?t.provider.useFactory(this):this.construct(t.provider,e),t.options.lifecycle===r.ResolutionScoped&&e.scopedResolutions.set(t,i),i},t.prototype.resolveAll=function(t,e){var r=this;void 0===e&&(e=new b),this.ensureNotDisposed();var i=this.getAllRegistrations(t);if(!i&&d(t))throw new Error('Attempted to resolve unregistered dependency token: "'+t.toString()+'"');if(this.executePreResolutionInterceptor(t,"All"),i){var s=i.map((function(t){return r.resolveRegistration(t,e)}));return this.executePostResolutionInterceptor(t,s,"All"),s}var n=[this.construct(t,e)];return this.executePostResolutionInterceptor(t,n,"All"),n},t.prototype.isRegistered=function(t,e){return void 0===e&&(e=!1),this.ensureNotDisposed(),this._registry.has(t)||e&&(this.parent||!1)&&this.parent.isRegistered(t,!0)},t.prototype.reset=function(){this.ensureNotDisposed(),this._registry.clear(),this.interceptors.preResolution.clear(),this.interceptors.postResolution.clear()},t.prototype.clearInstances=function(){var t,e;this.ensureNotDisposed();try{for(var r=a(this._registry.entries()),i=r.next();!i.done;i=r.next()){var s=l(i.value,2),n=s[0],o=s[1];this._registry.setAll(n,o.filter((function(t){return!v(t.provider)})).map((function(t){return t.instance=void 0,t})))}}catch(e){t={error:e}}finally{try{i&&!i.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}},t.prototype.createChildContainer=function(){var e,i;this.ensureNotDisposed();var s=new t(this);try{for(var n=a(this._registry.entries()),o=n.next();!o.done;o=n.next()){var h=l(o.value,2),c=h[0],u=h[1];u.some((function(t){return t.options.lifecycle===r.ContainerScoped}))&&s._registry.setAll(c,u.map((function(t){return t.options.lifecycle===r.ContainerScoped?{provider:t.provider,options:t.options}:t})))}}catch(t){e={error:t}}finally{try{o&&!o.done&&(i=n.return)&&i.call(n)}finally{if(e)throw e.error}}return s},t.prototype.beforeResolution=function(t,e,r){void 0===r&&(r={frequency:"Always"}),this.interceptors.preResolution.set(t,{callback:e,options:r})},t.prototype.afterResolution=function(t,e,r){void 0===r&&(r={frequency:"Always"}),this.interceptors.postResolution.set(t,{callback:e,options:r})},t.prototype.dispose=function(){return n(this,void 0,void 0,(function(){var t;return o(this,(function(e){switch(e.label){case 0:return this.disposed=!0,t=[],this.disposables.forEach((function(e){var r=e.dispose();r&&t.push(r)})),[4,Promise.all(t)];case 1:return e.sent(),[2]}}))}))},t.prototype.getRegistration=function(t){return this.isRegistered(t)?this._registry.get(t):this.parent?this.parent.getRegistration(t):null},t.prototype.getAllRegistrations=function(t){return this.isRegistered(t)?this._registry.getAll(t):this.parent?this.parent.getAllRegistrations(t):null},t.prototype.construct=function(t,e){var r=this;if(t instanceof f)return t.createProxy((function(t){return r.resolve(t,e)}));var i,s=function(){var i=L.get(t);if(!i||0===i.length){if(0===t.length)return new t;throw new Error('TypeInfo not known for "'+t.name+'"')}var s=i.map(r.resolveParams(e,t));return new(t.bind.apply(t,h([void 0],s)))}();return"function"!=typeof(i=s).dispose||i.dispose.length>0||this.disposables.add(s),s},t.prototype.resolveParams=function(t,e){var r=this;return function(i,s){var n,o,a,l;try{return"object"==typeof(l=i)&&"token"in l&&"multiple"in l?y(i)?i.multiple?(n=r.resolve(i.transform)).transform.apply(n,h([r.resolveAll(i.token)],i.transformArgs)):(o=r.resolve(i.transform)).transform.apply(o,h([r.resolve(i.token,t)],i.transformArgs)):i.multiple?r.resolveAll(i.token):r.resolve(i.token,t):y(i)?(a=r.resolve(i.transform,t)).transform.apply(a,h([r.resolve(i.token,t)],i.transformArgs)):r.resolve(i,t)}catch(t){throw new Error(S(e,s,t))}}},t.prototype.ensureNotDisposed=function(){if(this.disposed)throw new Error("This container has been disposed, you cannot interact with a disposed container")},t}(),M=new R;function k(t){return e=t,function(t,i,s){var n=Reflect.getOwnMetadata(c,t)||{};n[s]=r?{token:e,transform:r.transformToken,transformArgs:r.args||[]}:e,Reflect.defineMetadata(c,n,t)};var e,r}function A(){return function(t){L.set(t,function(t){var e=Reflect.getMetadata("design:paramtypes",t)||[],r=Reflect.getOwnMetadata(c,t)||{};return Object.keys(r).forEach((function(t){e[+t]=r[t]})),e}(t))}}function E(){return function(t){A()(t),M.registerSingleton(t)}}if("undefined"==typeof Reflect||!Reflect.getMetadata)throw new Error("tsyringe requires a reflect polyfill. Please add 'import \"reflect-metadata\"' to the top of your entry point.");const P="AssetsLoaded",O="KeyPress",C="PlayerLose",I="PlayerWin",j="GameOver",D="GameWin",N="Loading",F="Running",W="Title",B={BOOK:"book.wav",MONSTERHIT:"hit2.wav",NEWLEVEL:"newLevel.wav",PLAYERHIT:"hit1.wav",SPELL:"spell.wav"},H="effect",U="item",Y="Monster",X="tile",G="Library",z="N",V="E",K="S",q="W",J="NEXTLEVEL",Z="PREVLEVEL",Q="PLAYSOUND",$="SETSHAKE";class tt{constructor(){this.subscriptions=[]}static getInstance(){return tt.instance||(tt.instance=new tt),tt.instance}subscribe(t,e){this.subscriptions[t]||(this.subscriptions[t]=[]),this.subscriptions[t].push(e)}publish(t,e){this.subscriptions[t]&&this.subscriptions[t].forEach((t=>{t&&t(e)}))}}const et=16,rt=48,it=1e3/60,st="assets/images/";var nt=function(t,e,r,i){var s,n=arguments.length,o=n<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,r,i);else for(var a=t.length-1;a>=0;a--)(s=t[a])&&(o=(n<3?s(o):n>3?s(e,r,o):s(e,r))||o);return n>3&&o&&Object.defineProperty(e,r,o),o},ot=function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)};let at=class{constructor(){this.sounds={},this.initSounds(),tt.getInstance().subscribe(Q,this.playSound.bind(this))}initSounds(){for(const t of Object.values(B))this.sounds[t]=new Audio(`assets/sounds/${t}`)}playSound(t){t&&this.sounds[t]&&(this.sounds[t].currentTime=0,this.sounds[t].play())}};at=nt([E(),ot("design:paramtypes",[])],at);class lt{constructor(t,e){this.stateMatrix=t,this.currentState={name:""},this.previousState=null,this.enterState(e)}triggerEvent(t){const e=this.currentState.getNewState(t);e&&this.enterState(e)}enterState(t){t!==this.currentState.name&&(this.currentState.onExit&&this.currentState.onExit(),this.previousState=this.currentState,this.currentState=this.stateMatrix[t],this.currentState.onEnter&&this.currentState.onEnter())}}class ht{constructor(t,e,r,i){this.name=t||"",this.transformations=e||{},this.onEnter=r,this.onExit=i}getNewState(t){return t=t||"",this.transformations[t]?this.transformations[t]:null}}class ct{constructor(t,e,r,i){this.score=0,this.run=1,this.totalScore=0,this.active=!1,this.score=null!=t?t:0,this.run=null!=e?e:1,this.totalScore=null!=r?r:0,this.active=null!=i&&i}}const ut={Heal:[0,0],Flame:[1,0],Bolt_Horizontal:[2,0],Bolt_Vertical:[3,0]},pt=[0,0],ft={Player:[0,0],Player_Dead:[1,0],Bird:[2,0],Snake:[3,0],Tank:[4,0],Eater:[5,0],Jester:[6,0],HP:[7,0],MonsterLoad:[8,0],Turret_N:[9,0],Turret_E:[10,0],Turret_S:[11,0],Turret_W:[12,0]},dt={StairDown:[1,0],StairUp:[1,1],SpikePit:[2,0],FountainActive:[3,0],FountainInactive:[3,1],Wall:[0,2],Wall_L:[1,2],Wall_R:[2,2],Wall_LR:[3,2],Wall_T:[0,3],Wall_B:[1,3],Wall_TB:[2,3],Wall_LT:[3,3],Wall_RT:[0,4],Wall_LRT:[1,4],Wall_LB:[2,4],Wall_RB:[3,4],Wall_LRB:[0,5],Wall_LTB:[1,5],Wall_RTB:[2,5],Wall_LRTB:[3,5],Floor:[0,6],Floor_L:[1,6],Floor_R:[2,6],Floor_LR:[3,6],Floor_T:[0,7],Floor_B:[1,7],Floor_TB:[2,7],Floor_LT:[3,7],Floor_RT:[0,8],Floor_LRT:[1,8],Floor_LB:[2,8],Floor_RB:[3,8],Floor_LRB:[0,9],Floor_LTB:[1,9],Floor_RTB:[2,9],Floor_LRTB:[3,9]};class yt{constructor(t,e){this.caster=t,this.name=e}cast(){tt.getInstance().publish(Q,B.SPELL)}boltTravel(t,e,r,i){if(null===t.tile)return;let s=t.tile;for(;;){const t=s.getNeighbor(e[0],e[1]);if(!t||!t.passable)break;s=t,s.monster&&s.monster.hit(i),s.setEffect(r)}}}class gt{constructor(t,e,r,i,s){this.explored=!1,this.book=!1,this.effectIndex=null,this.effectCounter=0,this.stepEffectActive=!1,this.monster=null,this.map=t,this.x=e,this.y=r,this.sprite=i,this.passable=s}dist(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}getNeighbor(t,e){return this.map.getTile(this.x+t,this.y+e)}getAdjacentNeighbors(){return[this.getNeighbor(0,-1),this.getNeighbor(0,1),this.getNeighbor(-1,0),this.getNeighbor(1,0)]}getNeighborChain(t){let e=[0,0];switch(t){case z:e=[0,-1];break;case K:e=[0,1];break;case V:e=[1,0];break;case q:e=[-1,0];break;default:throw"Direction didn't have a valid value."}const r=[];let i=this.map.getTile(this.x,this.y);for(;null!=i;)i=i.getNeighbor(e[0],e[1]),i&&i.passable?r.push(i):i=null;return r}getAdjacentPassableNeighbors(){return this.getAdjacentNeighbors().filter((t=>t&&t.passable))}setEffect(t){this.effectIndex=t,this.effectCounter=30}}class vt extends gt{constructor(t,e,r){super(t,e,r,dt.Floor,!0)}stepOn(t){this.book&&t&&t.isPlayer&&(this.book=!1)}activate(t){console.log(t)}}const mt=[class extends yt{constructor(t){super(t,"WOOP")}cast(){if(null===this.caster.tile)return;super.cast();const t=this.caster.tile.map.randomPassableTile();t&&this.caster.setTile(t)}},class extends yt{constructor(t){super(t,"Quake")}cast(){if(null!==this.caster.tile){super.cast();for(let t=0;t<et;t++)for(let e=0;e<et;e++){const r=this.caster.tile.map.getTile(t,e);if(r&&r.monster&&r.monster!=this.caster){const t=4-r.getAdjacentPassableNeighbors().length;r.monster.hit(2*t)}}tt.getInstance().publish($,20)}}},class extends yt{constructor(t){super(t,"Tornado")}cast(){if(null===this.caster.tile)return;super.cast();const t=this.caster.tile.map.getMonsters();for(let e=0;e<t.length;e++){const r=t[e];if(r){const t=this.caster.tile.map.randomPassableTile();t&&(r.setTile(t),r.teleportCounter=2)}}}},class extends yt{constructor(t){super(t,"AURA")}cast(){null!==this.caster.tile&&(super.cast(),this.caster.tile.getAdjacentNeighbors().forEach((function(t){t&&(t.setEffect(ut.Heal),t.monster&&t.monster.heal(1))})),this.caster.tile.setEffect(ut.Heal),this.caster.heal(3))}},class extends yt{constructor(t){super(t,"DASH")}cast(){if(null===this.caster.tile)return;super.cast();let t=this.caster.tile;for(;;){const e=t.getNeighbor(this.caster.lastMove[0],this.caster.lastMove[1]);if(!e||!e.passable||e.monster)break;t=e}this.caster.tile!=t&&(this.caster.setTile(t),t.getAdjacentNeighbors().forEach((t=>{t&&t.monster&&(t.setEffect(ut.Flame),t.monster.stunned=!0,t.monster.hit(1))})))}},class extends yt{constructor(t){super(t,"FLATTEN")}cast(){if(null!==this.caster.tile){super.cast();for(let t=1;t<15;t++)for(let e=1;e<15;e++){const r=this.caster.tile.map.getTile(t,e);r&&!r.passable&&r.map.replaceTile(t,e,new vt(r.map,t,e))}this.caster.tile.setEffect(ut.Flame),this.caster.heal(2)}}},class extends yt{constructor(t){super(t,"ALCHEMY")}cast(){null!==this.caster.tile&&(super.cast(),this.caster.tile.getAdjacentNeighbors().forEach((function(t){t&&!t.passable&&t.map.replaceTile(t.x,t.y,new vt(t.map,t.x,t.y))})))}},class extends yt{constructor(t){super(t,"BOLT")}cast(){null!==this.caster.tile&&(super.cast(),super.boltTravel(this.caster,this.caster.lastMove,[15+Math.abs(this.caster.lastMove[1])],4))}},class extends yt{constructor(t){super(t,"CROSS"),this.directions=[[0,-1],[0,1],[-1,0],[1,0]]}cast(){if(null!==this.caster.tile){super.cast();for(let t=0;t<this.directions.length;t++){const e=0==Math.abs(this.directions[t][1])?ut.Bolt_Horizontal:ut.Bolt_Vertical;super.boltTravel(this.caster,this.directions[t],e,2)}}}},class extends yt{constructor(t){super(t,"EX"),this.directions=[[-1,-1],[-1,1],[1,-1],[1,1]]}cast(){if(null!==this.caster.tile){super.cast();for(let t=0;t<this.directions.length;t++)super.boltTravel(this.caster,this.directions[t],ut.Flame,3)}}}];function wt(t,e){return Math.floor(Math.random()*(e-t+1))+t}function bt(t){let e,r;for(let i=1;i<t.length;i++)r=wt(0,i),e=t[i],t[i]=t[r],t[r]=e;return t}class St{constructor(t,e,r){this.isPlayer=!1,this.stunned=!1,this.attackedThisTurn=!1,this.tile=t,this.isPlayer=!1,this.stunned=!1,this.attackedThisTurn=!1,null!==t&&this.setTile(t),this.sprite=e,this.hp=r,this.teleportCounter=2,this.offsetX=0,this.offsetY=0,this.lastMove=[0,0],this.hitSFX=B.MONSTERHIT}heal(t){this.hp=Math.min(6,this.hp+t),tt.getInstance().publish(Q,B.PLAYERHEAL)}isDead(){return 0==this.hp}tickUpdate(){this.teleportCounter--,this.stunned||this.teleportCounter>0?this.stunned=!1:this.act()}act(){if(null===this.tile)return;const t=this.tile.getAdjacentPassableNeighbors().filter((t=>t&&(!t.monster||t.monster.isPlayer)));t.length&&(t.sort(((t,e)=>t.dist(this.tile)-e.dist(this.tile))),this.tryMove(t[0].x-this.tile.x,t[0].y-this.tile.y))}getDisplayX(){return null===this.tile?-1:this.tile.x+this.offsetX}getDisplayY(){return null===this.tile?-1:this.tile.y+this.offsetY}tryMove(t,e){if(null===this.tile)return!1;const r=this.tile.getNeighbor(t,e);return!(!r||!r.passable)&&(this.lastMove=[t,e],r.monster?this.isPlayer!=r.monster.isPlayer&&(this.attackedThisTurn=!0,r.monster.stunned=!0,r.monster.hit(1),tt.getInstance().publish($,5),this.offsetX=(r.x-this.tile.x)/2,this.offsetY=(r.y-this.tile.y)/2):this.setTile(r),!0)}hit(t){tt.getInstance().publish(Q,this.hitSFX),this.hp-=t,this.hp<=0&&(this.die(),this.tile instanceof vt&&(this.tile.book=!0))}die(){null!==this.tile&&(this.tile.monster=null),this.isPlayer&&(this.sprite=ft.Player_Dead)}setTile(t,e=!1){null!==this.tile&&(this.tile.monster=null,e?(this.offsetX=0,this.offsetY=0):(this.offsetX=this.tile.x-t.x,this.offsetY=this.tile.y-t.y)),this.tile=t,t.monster=this,t.stepOn(this)}}class xt extends St{constructor(t){super(t,ft.Player,3),this.score=0,this.hp=3,this.isPlayer=!0,this.teleportCounter=0,this.spells=bt(mt)[0],this.hitSFX=B.PLAYERHIT}tickUpdate(){}activateTile(){this.tile&&this.tile.activate(this)}}var Tt=function(t,e,r,i){var s,n=arguments.length,o=n<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,r,i);else for(var a=t.length-1;a>=0;a--)(s=t[a])&&(o=(n<3?s(o):n>3?s(e,r,o):s(e,r))||o);return n>3&&o&&Object.defineProperty(e,r,o),o},_t=function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},Lt=function(t,e){return function(r,i){e(r,i,t)}};let Rt=class{constructor(t,e,r){this.audioPlayer=t,this.mapper=e,this.renderer=r,this.localStorage={},this.level=1,this.player=new xt(null),this.numSpells=1,this.score=0,this.spawnCounter=0,this.spawnRate=15,this.sidebarNeedsUpdate=!1;const i={Loading:new ht(N,{AssetsLoaded:W},this.loadAssets.bind(this),null),Title:new ht(W,{KeyPress:F},this.showTitle.bind(this),null),Running:new ht(F,{PlayerLose:j,PlayerWin:D},this.startGame.bind(this),null),GameOver:new ht(j,{KeyPress:W},this.showGameLose.bind(this),null),GameWin:new ht(D,{KeyPress:W},this.showGameWin.bind(this),null)};this.FSM=new lt(i,N),this.lastAnimateUpdate=(new Date).getTime()}init(){this.addEventHandlers(),requestAnimationFrame(this.draw.bind(this))}loadAssets(){this.renderer.initSpriteSheet((()=>{this.FSM.triggerEvent(P)}))}addEventHandlers(){const t=this,e=document.querySelector("html");e&&(e.onkeydown=t.handleInteraction.bind(this)),window.addEventListener("touchstart",t.handleInteraction.bind(this)),window.addEventListener("mousedown",t.handleInteraction.bind(this)),tt.getInstance().subscribe(J,t.nextLevel.bind(this)),tt.getInstance().subscribe(Z,t.prevLevel.bind(this))}handleInteraction(t){switch(this.FSM.currentState.name){case N:break;case F:t&&this.handleKeypress(t);break;default:this.FSM.triggerEvent(O)}}handleKeypress(t){if(!(t=t||window.event).defaultPrevented){switch(t.key){case"Up":case"ArrowUp":case"w":case"W":this.player.tryMove(0,-1);break;case"Down":case"ArrowDown":case"s":case"S":this.player.tryMove(0,1);break;case"Left":case"ArrowLeft":case"a":case"A":this.player.tryMove(-1,0);break;case"Right":case"ArrowRight":case"d":case"D":this.player.tryMove(1,0);break;case" ":this.player.tryMove(0,0);break;case"Enter":case"Return":this.player.activateTile()}this.tick()}}draw(){if(this.FSM.currentState.name==F){const t=(new Date).getTime();t>=this.lastAnimateUpdate+it&&(this.lastAnimateUpdate=t,this.renderer.updateScreen(this.mapper.getCurrentLevel()),this.sidebarNeedsUpdate&&(this.sidebarNeedsUpdate=!1,this.renderer.updateSidebar(this.level,this.score,null))),requestAnimationFrame(this.draw.bind(this))}}tick(){const t=this.mapper.getCurrentLevel();if(t){const e=t.getMonsters();for(let r=e.length-1;r>=0;r--)e[r].isDead()?t.removeActor(e[r]):e[r].tickUpdate();this.player.tickUpdate(),this.player.isDead()&&(this.AddScoreAndGetList(this.score,!1),this.sidebarNeedsUpdate=!0,this.FSM.triggerEvent(C)),this.spawnCounter--,this.spawnCounter<=0&&(t.spawnMonster(),this.spawnCounter=this.spawnRate,this.spawnRate--)}}showTitle(){this.renderer.showTitle(this.getScores())}showGameWin(){const t=this.AddScoreAndGetList(this.score,!0);this.renderer.showGameWin(t)}showGameLose(){const t=this.AddScoreAndGetList(this.score,!0);this.renderer.showGameLose(t)}startGame(){this.renderer.hideOverlays(),this.level=1,this.score=0,this.numSpells=1,this.mapper.reset();this.mapper.getOrCreateLevel(this.level)?(this.moveToLevel(this.level),this.tick(),this.draw()):console.error("Failed to create first level")}moveToLevel(t,e=!1){this.spawnRate=15,this.spawnCounter=this.spawnRate;const r=this.mapper.getOrCreateLevel(t),i=this.mapper.getCurrentLevel();i&&this.player&&this.player.tile?i.removeActor(this.player):this.player=new xt(null),this.player.offsetX=0,this.player.offsetY=0,this.player.stunned=!1,this.player.lastMove=[0,0],r.addActor(this.player,e),this.sidebarNeedsUpdate=!0}AddScoreAndGetList(t,e){const r=this.getScores(),i=new ct(t,1,t,e),s=r.pop();return s&&(s.active?(i.run=s.run+1,i.totalScore+=s.totalScore):r.push(s)),r.push(i),this.localStorage.scores=JSON.stringify(r),r}getScores(){return this.localStorage.scores?JSON.parse(this.localStorage.scores):[]}prevLevel(){this.level>1&&(this.level--,this.moveToLevel(this.level,!0))}nextLevel(){10==this.level?this.FSM.triggerEvent(I):(this.audioPlayer.playSound(B.NEWLEVEL),this.level++,this.moveToLevel(this.level))}};Rt=Tt([E(),Lt(0,k("IAudioPlayer")),Lt(1,k("IMapper")),Lt(2,k("IRenderer")),_t("design:paramtypes",[Object,Object,Object])],Rt);class Mt extends gt{constructor(t,e,r){super(t,e,r,dt.FountainActive,!0),this.stepEffectActive=!0}stepOn(t){console.log(t)}activate(t){this.stepEffectActive&&t&&t.isPlayer&&(this.stepEffectActive=!1,this.sprite=dt.FountainInactive,t.heal(10))}}class kt extends gt{constructor(t,e,r){super(t,e,r,dt.SpikePit,!0)}stepOn(t){t&&(t.hit(1),t.isPlayer&&tt.getInstance().publish($,5))}activate(t){console.log(t)}}class At extends gt{constructor(t,e,r){super(t,e,r,dt.Wall,!1)}stepOn(t){throw console.log(t),new Error("Shouldn't be able to step on a wall tile")}activate(t){throw console.log(t),new Error("Shouldn't be able to activate a wall tile")}}class Et{constructor(t,e,r,i){this.x=0,this.y=0,this.width=0,this.height=0,this.maxX=0,this.maxY=0,this.centerX=0,this.centerY=0,this.x=t||0,this.y=e||0,this.width=r||0,this.height=i||0,this.maxX=this.x+this.width,this.maxY=this.y+this.height,this.centerX=this.width>0?Math.ceil(this.x+this.width/2):0,this.centerY=this.height>0?Math.ceil(this.y+this.height/2):0}isZero(){return 0===this.x&&0===this.y&&0===this.width&&0===this.height}}class Pt{constructor(t,e,r,i){this.x=t,this.y=e,this.leafWidth=r,this.leafHeight=i,this.childLeafLeft=null,this.childLeafRight=null,this.room=new Et(0,0,0,0),this.room1=new Et(0,0,0,0),this.room2=new Et(0,0,0,0)}createRooms(t,e,r,i){if(null!==this.childLeafLeft||null!==this.childLeafRight)this.childLeafLeft&&this.childLeafLeft.createRooms(t,e,r,i),this.childLeafRight&&this.childLeafRight.createRooms(t,e,r,i),this.childLeafLeft&&this.childLeafRight&&t.createHall(this.childLeafLeft.getRoom(),this.childLeafRight.getRoom());else{const e=this.getRandomIntBetweenMinAndMax(i,Math.min(r,this.leafWidth-1)),s=this.getRandomIntBetweenMinAndMax(i,Math.min(r,this.leafHeight-1)),n=this.getRandomIntBetweenMinAndMax(this.x,this.x+(this.leafWidth-1)-e),o=this.getRandomIntBetweenMinAndMax(this.y,this.y+(this.leafHeight-1)-s);this.room=new Et(n,o,e,s),t.placeRoom(this.room)}}getRandomIntBetweenMinAndMax(t,e){return Math.floor(Math.random()*(e-t+1)+t)}splitLeaf(t){if(null!==this.childLeafLeft||null!==this.childLeafRight)return!1;let e=Math.random()>=.5;const r=this.leafWidth/this.leafHeight,i=this.leafHeight/this.leafWidth;r>=1.25?e=!1:i>=1.25&&(e=!0);const s=e?this.leafHeight-t:this.leafWidth-t;if(s<=t)return!1;const n=this.getRandomIntBetweenMinAndMax(t,s);return e?(this.childLeafLeft=new Pt(this.x,this.y,this.leafWidth,n),this.childLeafRight=new Pt(this.x,this.y+n,this.leafWidth,this.leafHeight-n)):(this.childLeafLeft=new Pt(this.x,this.y,n,this.leafHeight),this.childLeafRight=new Pt(this.x+n,this.y,this.leafWidth-n,this.leafHeight)),!0}getRoom(){if(!this.room.isZero())return this.room;if(this.childLeafLeft&&(this.room1=this.childLeafLeft.getRoom()),this.childLeafRight&&(this.room2=this.childLeafRight.getRoom()),this.childLeafLeft||this.childLeafRight){if(this.room2.isZero())return this.room1;if(this.room1.isZero())return this.room2;return Math.random()>=.5?this.room1:this.room2}return new Et(0,0,0,0)}}class Ot extends St{constructor(t){super(t,ft.Bird,3)}}class Ct extends St{constructor(t){super(t,ft.Snake,1)}act(){this.attackedThisTurn=!1,super.act(),this.attackedThisTurn||super.act()}}class It extends St{constructor(t){super(t,ft.Tank,2)}tickUpdate(){const t=this.stunned;super.tickUpdate(),t||(this.stunned=!0)}}class jt extends St{constructor(t){super(t,ft.Eater,1)}act(){if(null===this.tile)return;const t=this.tile.getAdjacentNeighbors().filter((t=>t&&!t.passable));if(t.length){const e=bt(t)[0];e&&(e.map.replaceTile(e.x,e.y,new vt(e.map,e.x,e.y)),this.heal(.5))}else super.act()}}class Dt extends St{constructor(t){super(t,ft.Jester,2)}act(){if(null===this.tile)return;const t=this.tile.getAdjacentPassableNeighbors();if(t.length){const e=bt(t)[0];this.tryMove(e.x-this.tile.x,e.y-this.tile.y)}}}class Nt extends St{constructor(t){super(t,ft.Turret,1),this.directions=[z,V,K,q],this.currentDirection=wt(0,3)}act(){if(null===this.tile)return;this.currentDirection+=1,4==this.currentDirection&&(this.currentDirection=0);const t=this.directions[this.currentDirection];this.sprite=ft["Turret_"+t];const e=this.tile.getNeighborChain(t);e.some((t=>t.monster&&t.monster.isPlayer))&&e.forEach((e=>{switch(e.monster&&e.monster.hit(1),t){case z:case K:e.setEffect(ut.Bolt_Vertical);break;case V:case q:e.setEffect(ut.Bolt_Horizontal);break;default:throw"CardinalDirection didn't have a valid value."}}))}}class Ft extends gt{constructor(t,e,r){super(t,e,r,dt.StairUp,!0)}stepOn(t){console.log(t)}activate(t){t&&t.isPlayer&&this.map.prevLevel()}}class Wt extends gt{constructor(t,e,r){super(t,e,r,dt.StairDown,!0)}stepOn(t){console.log(t)}activate(t){t&&t.isPlayer&&this.map.nextLevel()}}class Bt{constructor(t,e){this.height=0,this.width=0,this.branch=G,this.stairsUp=null,this.stairsDown=null,this.width=t,this.height=e,this.monsters=new Array,this.tiles=new Array}getStairUpTile(){return this.stairsUp}getStairDownTile(){return this.stairsDown}setStairDownTile(){const t=this.randomPassableTile();return t&&(this.stairsDown=new Wt(this,t.x,t.y),this.replaceTile(t.x,t.y,this.stairsDown)),this.getStairDownTile()}setStairUpTile(){const t=this.randomPassableTile();return t&&(this.stairsUp=new Ft(this,t.x,t.y),this.replaceTile(t.x,t.y,this.stairsUp)),this.getStairUpTile()}removeActor(t){this.monsters=this.monsters.filter((e=>e!==t))}addActor(t,e=!1){this.monsters.push(t);let r=e?this.stairsDown:this.stairsUp;null===r&&(console.log("no stairs, placing on random tile"),r=this.randomPassableTile()),null!==r&&(console.log("placing actor on tile",r),t.setTile(r,!0))}getMonsters(){return this.monsters}getPlayer(){return this.monsters.find((t=>t.isPlayer))||null}getTile(t,e){try{if(this.inBounds(t,e))return this.tiles[t][e]}catch(r){console.log(r,t,e)}return null}nextLevel(){tt.getInstance().publish(J,null)}prevLevel(){tt.getInstance().publish(Z,null)}randomPassableTile(){const t=this;let e=null;return function(t,e){for(let t=1e3;t>0;t--)if(e())return;throw"Timeout while trying to "+t}("get random passable tile",(function(){const r=wt(0,t.width-1),i=wt(0,t.height-1);return e=t.getTile(r,i),e&&e.passable&&!e.monster})),e}replaceTile(t,e,r){if(!this.inBounds(t,e))throw"attempting to replace a tile at non-existant location";this.tiles[t][e]=r}spawnMonster(){const t=new(0,bt([Ot,Ct,It,jt,Dt,Nt])[0])(this.randomPassableTile());this.monsters.push(t)}inBounds(t,e){return t>=0&&e>=0&&t<this.width&&e<this.height}}class Ht{constructor(t){this.levelIdx=t;const e=Math.floor(.16*(10*t+100));this.map=new Bt(e,e)}generateLevel(t,e){this.levelIdx=t;const r=Math.floor(.16*(10*t+100));return this.map=new Bt(r,r),this.generateTiles(),this.populateMap(),this.map}generateTiles(){for(let t=0;t<this.map.width;t++){this.map.tiles[t]=[];for(let e=0;e<this.map.height;e++)if(0==t||0==e||t==this.map.width-1||e==this.map.height-1)this.map.tiles[t][e]=new At(this.map,t,e);else{const r=Math.random();this.map.tiles[t][e]=r<.005?new Mt(this.map,t,e):r<.02?new kt(this.map,t,e):r<.3?new At(this.map,t,e):new vt(this.map,t,e)}}}populateMap(){this.generateMonsters(),this.placeBooks(),this.placeStairsDown(),console.log("Level "+this.levelIdx+" generated"),this.levelIdx>0&&(console.log("Placing stairs up"),this.placeStairsUp()),this.overrideWallSpritesOnEdges()}generateMonsters(){const t=Math.ceil((this.levelIdx+1)/2)+1;for(let e=0;e<t;e++)this.map.monsters.push(this.spawnMonster())}spawnMonster(){return new(0,bt([Ot,Ct,It,jt,Dt,Nt])[0])(this.map.randomPassableTile())}placeBooks(){let t=0;for(;t<3;){const e=this.map.randomPassableTile();e&&e instanceof vt&&(t++,e.book=!0)}}placeStairsDown(){this.map.setStairDownTile()}placeStairsUp(){this.map.setStairUpTile()}overrideWallSpritesOnEdges(){for(let t=0;t<this.map.height;t++)for(let e=0;e<this.map.width;e++){const r=this.map.getTile(e,t);if(r instanceof At){const t=r.getAdjacentNeighbors();if(t&&t.length>0){const e=this.getSpriteVariationSuffixForTile(t,At);e&&(r.sprite=dt["Wall_"+e])}}}}getSpriteVariationSuffixForTile(t,e){let r="";return t[2]&&t[2]instanceof e&&(r+="L"),t[3]&&t[3]instanceof e&&(r+="R"),t[0]&&t[0]instanceof e&&(r+="T"),t[1]&&t[1]instanceof e&&(r+="B"),r}}class Ut extends Ht{constructor(t){super(t),this.maxLeafSize=12,this.minLeafSize=3,this.roomMaxSize=10,this.roomMinSize=3,this.leaves=[],this.maxLeafSize=this.maxLeafSize+t,this.generate()}generate(){this.generateTiles(),super.populateMap()}generateTiles(){this.initialiseMap();const t=new Pt(0,0,this.map.width,this.map.height);this.leaves.push(t);let e=!0;for(;e;){e=!1;for(let t=0;t<this.leaves.length;t++){const r=this.leaves[t];r&&(r.childLeafLeft||r.childLeafRight||!(r.leafWidth>this.maxLeafSize||r.leafHeight>this.maxLeafSize)||r.splitLeaf(this.minLeafSize)&&(r.childLeafLeft&&this.leaves.push(r.childLeafLeft),r.childLeafRight&&this.leaves.push(r.childLeafRight),e=!0))}}t.createRooms(this,this.maxLeafSize,this.roomMaxSize,this.roomMinSize)}initialiseMap(){for(let t=0;t<this.map.width;t++){this.map.tiles[t]=[];for(let e=0;e<this.map.height;e++)this.map.tiles[t][e]=new At(this.map,t,e)}}placeRoom(t){for(let e=t.x+1;e<t.maxX;e++)for(let r=t.y+1;r<t.maxY;r++){const t=Math.random();this.map.tiles[e][r]=t<.005?new Mt(this.map,e,r):t<.02?new kt(this.map,e,r):new vt(this.map,e,r)}}createHall(t,e){Math.random()>=.5?(this.makeHorizontalTunnel(t.centerX,e.centerX,t.centerY),this.makeVerticalTunnel(t.centerY,e.centerY,e.centerX)):(this.makeVerticalTunnel(t.centerY,e.centerY,t.centerX),this.makeHorizontalTunnel(t.centerX,e.centerX,e.centerY))}makeHorizontalTunnel(t,e,r){const i=Math.min(t,e),s=Math.max(t,e);for(let t=i;t<=s;t++)this.map.tiles[t][r]=new vt(this.map,t,r)}makeVerticalTunnel(t,e,r){for(let i=Math.min(t,e);i<=Math.max(t,e);i++)this.map.tiles[r][i]=new vt(this.map,r,i)}}class Yt{generateLevel(t,e){if(e===G)return this.generateLibraryLevel(t);throw"branch not supported"}generateLibraryLevel(t){return new Ut(t).map}}var Xt=function(t,e,r,i){var s,n=arguments.length,o=n<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,r,i);else for(var a=t.length-1;a>=0;a--)(s=t[a])&&(o=(n<3?s(o):n>3?s(e,r,o):s(e,r))||o);return n>3&&o&&Object.defineProperty(e,r,o),o},Gt=function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},zt=function(t,e){return function(r,i){e(r,i,t)}};let Vt=class{constructor(t){this.levelGenerator=t,this.currentFloorIdx=0,this.floors=new Array}getOrCreateLevel(t){let e=this.floors[t];return void 0!==e?(this.currentFloorIdx=t,e):(e=this.levelGenerator.generateLevel(t,G),this.currentFloorIdx=t,this.floors[t]=e,e)}getCurrentLevel(){return void 0===this.floors[this.currentFloorIdx]?this.getOrCreateLevel(this.currentFloorIdx):this.floors[this.currentFloorIdx]}reset(){this.floors=new Array}};Vt=Xt([E(),zt(0,k("ILevelGenerator")),Gt("design:paramtypes",[Object])],Vt);class Kt{constructor(){this.amount=0,this.x=0,this.y=0}}var qt=function(t,e,r,i){var s,n=arguments.length,o=n<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,r,i);else for(var a=t.length-1;a>=0;a--)(s=t[a])&&(o=(n<3?s(o):n>3?s(e,r,o):s(e,r))||o);return n>3&&o&&Object.defineProperty(e,r,o),o},Jt=function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)};let Zt=class{constructor(){this.showAlternateSprites=!1,this.viewportWidth=16,this.viewportHeight=16,this.viewportX=0,this.viewportY=0,this.lastAlternateSpriteTimeMS=Date.now(),this.monsterSpriteSheet=new Image,this.tileSpriteSheet=new Image,this.effectSpriteSheet=new Image,this.itemSpriteSheet=new Image,this.onLoadCompletedCallback=null;const t=document.getElementById("playerLocation");if(!t)throw"can't load pleyer location elem";this.playerLocationElem=t;const e=document.getElementById("playerBooks");if(!e)throw"can't load Player Books elem";this.playerBooksElem=e,this.shake=new Kt;const r=document.querySelector("canvas");if(!r)throw"Canvas can't load";{this.canvas=r;const t=this.canvas.getContext("2d");if(!t)throw"Ctx can't load";this.ctx=t}this.setupCanvas(),tt.getInstance().subscribe($,this.setShakeAmount.bind(this))}initSpriteSheet(t){this.onLoadCompletedCallback=t,this.monsterSpriteSheet.onload=this.checkAllSpriteSheetsLoaded.bind(this),this.tileSpriteSheet.onload=this.checkAllSpriteSheetsLoaded.bind(this),this.effectSpriteSheet.onload=this.checkAllSpriteSheetsLoaded.bind(this),this.itemSpriteSheet.onload=this.checkAllSpriteSheetsLoaded.bind(this),this.monsterSpriteSheet.src=st+"monsters1.png",this.tileSpriteSheet.src=st+"library_new.png",this.effectSpriteSheet.src=st+"effects.png",this.itemSpriteSheet.src=st+"items.png"}checkAllSpriteSheetsLoaded(){this.monsterSpriteSheet.complete&&this.tileSpriteSheet.complete&&this.effectSpriteSheet.complete&&this.itemSpriteSheet.complete&&null!==this.onLoadCompletedCallback&&this.onLoadCompletedCallback()}setupCanvas(){this.canvas&&this.ctx&&(this.canvas.width=rt*this.viewportWidth,this.canvas.height=rt*this.viewportHeight,this.canvas.style.width=this.canvas.width+"px",this.canvas.style.height=this.canvas.height+"px",this.ctx.imageSmoothingEnabled=!1,this.ctx.font="consolas, monospace")}getSpriteSheet(t){switch(t){case Y:return this.monsterSpriteSheet;case X:return this.tileSpriteSheet;case H:return this.effectSpriteSheet;case U:return this.itemSpriteSheet;default:throw"Sprite sheet does not exist!"}}updateScreen(t){this.clearCanvas(),this.screenshake();const e=Date.now();e-this.lastAlternateSpriteTimeMS>600&&(this.showAlternateSprites=!this.showAlternateSprites,this.lastAlternateSpriteTimeMS=e);const r=[],i=t.getPlayer();i&&i.tile&&(this.viewportX=Math.max(0,Math.min(t.width-this.viewportWidth,i.tile.x-Math.floor(this.viewportWidth/2))),this.viewportY=Math.max(0,Math.min(t.height-this.viewportHeight,i.tile.y-Math.floor(this.viewportHeight/2))));for(let e=this.viewportX;e<Math.min(this.viewportX+this.viewportWidth,t.width);e++)for(let i=this.viewportY;i<Math.min(this.viewportY+this.viewportHeight,t.height);i++){const s=t.getTile(e,i);s&&(this.drawTile(s),s.monster&&r.push(s.monster))}for(let t=0;t<r.length;t++){const e=r[t];if(!e.tile)continue;const i=e.tile.x,s=e.tile.y;i>=this.viewportX&&i<this.viewportX+this.viewportWidth&&s>=this.viewportY&&s<this.viewportY+this.viewportHeight&&this.drawMonster(e)}}drawTile(t){if(!t)throw"tile cannot be null";const e=t.x-this.viewportX,r=t.y-this.viewportY;this.drawSprite(X,t.sprite,e,r),t.book&&this.drawSprite(U,pt,e,r),t.effectCounter>0&&(t.effectCounter--,this.drawSprite(H,t.effectIndex,e,r,t.effectCounter))}drawMonster(t){if(!t)throw"Monster cannot be null";const e=t.getDisplayX()-this.viewportX,r=t.getDisplayY()-this.viewportY;if(t.teleportCounter>0)this.drawSprite(Y,ft.MonsterLoad,e,r);else{this.drawSprite(Y,t.sprite,e,r);for(let i=0;i<t.hp;i++)this.drawSprite(Y,ft.HP,e+i%3*(5/16),r-Math.floor(i/3)*(5/16))}t.offsetX-=Math.sign(t.offsetX)*(1/8),t.offsetY-=Math.sign(t.offsetY)*(1/8)}drawSprite(t,e,r,i,s=0){if(t===H&&s&&s>0&&(this.ctx.globalAlpha=s/it),e){const n=e[0];let o=e[1];t===Y&&this.showAlternateSprites&&(o=1),this.ctx.drawImage(this.getSpriteSheet(t),16*n,16*o,16,16,r*rt+this.shake.x,i*rt+this.shake.y,rt,rt),t===H&&(!s||s<=0)&&(this.ctx.globalAlpha=1)}}clearCanvas(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}screenshake(){this.shake.amount&&this.shake.amount--;const t=Math.random()*Math.PI*2;this.shake.x=Math.round(Math.cos(t)*this.shake.amount),this.shake.y=Math.round(Math.sin(t)*this.shake.amount)}hideOverlays(){const t=document.getElementsByClassName("overlay");if(t)for(let e=0;e<t.length;e++)if(t[e]){t[e].style.display="none"}}showTitle(t){const e=document.getElementById("TitleOverlay");e&&(t&&t.length>0&&this.drawScores(t),e.style.display="block")}showGameWin(t){const e=document.getElementById("GameWinOverlay");e&&(t&&t.length>0&&this.drawScores(t),e.style.display="block")}showGameLose(t){const e=document.getElementById("GameLoseOverlay");e&&(t&&t.length>0&&this.drawScores(t),e.style.display="block")}updateSidebar(t,e,r){this.playerBooksElem.innerText=e.toString(),this.playerLocationElem.innerText=t.toString();const i=document.getElementById("spells");if(i){for(;i.hasChildNodes();)i.firstChild&&i.removeChild(i.firstChild);const t=document.createDocumentFragment();if(null!=r)for(let e=0;e<Object.keys(r).length;e++){const i=document.createElement("button");i.className="spellButton",i.innerText="("+(e+1)+") "+(r[e].name||""),t.append(i)}i.appendChild(t)}}drawScores(t){const e=t.pop();void 0!==e&&(t.sort((function(t,e){return e.totalScore-t.totalScore})),t.unshift(e));const r=document.getElementsByClassName("scores");for(let e=0;e<r.length;e++){const i=r[e].children[1];if(i)for(;i.hasChildNodes();)i.firstChild&&i.removeChild(i.firstChild);const s=new DocumentFragment;for(let e=0;e<Math.min(10,t.length);e++){const r=document.createElement("tr"),i=document.createElement("td"),n=document.createElement("td"),o=document.createElement("td");i.innerHTML=t[e].run.toString(),n.innerHTML=t[e].score.toString(),o.innerHTML=t[e].totalScore.toString(),r.appendChild(i),r.appendChild(n),r.appendChild(o),s.appendChild(r)}i.appendChild(s)}}setShakeAmount(t){this.shake.amount=t}};Zt=qt([E(),Jt("design:paramtypes",[])],Zt);var Qt=function(t,e,r,i){var s,n=arguments.length,o=n<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,r,i);else for(var a=t.length-1;a>=0;a--)(s=t[a])&&(o=(n<3?s(o):n>3?s(e,r,o):s(e,r))||o);return n>3&&o&&Object.defineProperty(e,r,o),o},$t=function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)};let te=class{constructor(){M.register("IAudioPlayer",{useClass:at}),M.register("ILevelGenerator",{useClass:Yt}),M.register("IMapper",{useClass:Vt}),M.register("IRenderer",{useClass:Zt}),this.game=M.resolve(Rt)}init(){this.game.init()}};te=Qt([A(),$t("design:paramtypes",[])],te);var ee=te;export{ee as default};
